BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.FormManager=function(t){this.params=t||{},this.componentId=t.componentId,this.button=t.button,this.ajaxUrl=t.ajaxUrl,this.formParams={},this.modalLoaded=!1,this.init()},BX.DDAPP.Tools.FormManager.prototype={init:function(){if(console.log("FormManager: Params",this.params),this.ensureToastContainer(),this.formParams=JSON.parse(this.button.getAttribute("data-form-params")||"{}"),0===Object.keys(this.formParams).length)return console.error("FormManager: The formParams is empty",this.formParams),void this.showToast("Ошибка в параметрах формы","error");this.button&&this.button.addEventListener("click",this.handleButtonClick.bind(this))},ensureToastContainer:function(){var t="ddapp-toast-container",o=document.getElementById(t);o||((o=document.createElement("div")).id=t,o.className="toast-container position-fixed top-0 end-0 p-3",o.style.zIndex="9999",document.body.appendChild(o)),this.toastContainer=o},showToast:function(t,o,e){o=o||"info",e=e||5e3;var s="toast_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),n={success:{bgClass:"bg-success"},error:{bgClass:"bg-danger"},warning:{bgClass:"bg-warning text-dark"},info:{bgClass:"bg-info"}},a=`\n            <div id="${s}" class="toast align-items-center text-white ${(n[o]||n.info).bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">\n                <div class="d-flex">\n                    <div class="toast-body">\n                        ${t}\n                    </div>\n                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Закрыть"></button>\n                </div>\n            </div>`;this.toastContainer.insertAdjacentHTML("beforeend",a);var r=document.getElementById(s),i=new bootstrap.Toast(r,{delay:e,autohide:!0});return r.addEventListener("hidden.bs.toast",function(){r.remove()}),i.show(),i},handleButtonClick:function(t){t.preventDefault(),this.modalLoaded?this.showModal():this.loadModal()},loadModal:function(){var t={action:"load",id:this.componentId,"form-params":this.formParams,template:this.button.getAttribute("data-template"),sessid:BX.bitrix_sessid()};console.log("FormManager: Loading modal",t),BX.ajax({url:this.ajaxUrl,method:"POST",data:t,dataType:"json",onsuccess:this.onModalLoaded.bind(this),onfailure:this.onLoadError.bind(this)})},onModalLoaded:function(t){t&&"success"===t.status?(document.body.insertAdjacentHTML("beforeend",t.html),this.modalLoaded=!0,this.initFormHandlers(),this.showModal(),this.setupModalCleanup()):(console.error("FormManager: Unexpected response",t),this.showToast("Ошибка загрузки формы","error"))},onLoadError:function(t){console.error("FormManager: Modal load error",t),this.showToast("Ошибка загрузки модального окна","error")},showModal:function(){var t=document.getElementById(this.componentId+"_modal");t&&(new bootstrap.Modal(t,{backdrop:!0,keyboard:!0,focus:!0}).show(),t.addEventListener("shown.bs.modal",function(){var o=t.querySelector('input[type="text"]');o&&o.focus()},{once:!0}))},setupModalCleanup:function(){var t=document.getElementById(this.componentId+"_modal"),o=this;t&&(t.addEventListener("hide.bs.modal",function(){var e=t.querySelector(":focus");e&&e.blur(),o.button&&setTimeout(function(){o.button.focus()},100)}),t.addEventListener("hidden.bs.modal",function(){this.remove(),o.modalLoaded=!1}))},initFormHandlers:function(){var t=document.getElementById(this.componentId+"_form"),o=document.getElementById(this.componentId+"_input"),e=document.getElementById(this.componentId+"_message");t&&t.addEventListener("submit",function(t){t.preventDefault(),this.handleFormSubmit(o.value,e)}.bind(this))},handleFormSubmit:function(t,o){var e={action:"save",id:this.componentId,"form-params":this.formParams,template:this.button.getAttribute("data-template"),sessid:BX.bitrix_sessid()};console.log("FormManager: Submitting form",e),BX.ajax({url:this.ajaxUrl,method:"POST",data:e,dataType:"json",onsuccess:function(t){this.onFormResponse(t,o)}.bind(this),onfailure:function(t){this.onFormError(t,o)}.bind(this)})},onFormResponse:function(t,o){console.log("FormManager: Form response",t),t&&t.status?(this.showMessage(o,t.message,t.status),"success"===t.status&&this.showToast(t.message,"success")):(console.error("FormManager: Invalid response format",t),this.showMessage(o,"Ошибка формата ответа","error"),this.showToast("Ошибка формата ответа","error"))},onFormError:function(t,o){console.error("FormManager: Form submission error",t),this.showMessage(o,"Ошибка отправки запроса","error"),this.showToast("Ошибка отправки запроса","error")},showMessage:function(t,o,e){t&&(t.className="alert",t.classList.remove("d-none","alert-success","alert-danger"),"success"===e?t.classList.add("alert-success"):t.classList.add("alert-danger"),t.textContent=o)},destroy:function(){this.button&&this.button.removeEventListener("click",this.handleButtonClick);var t=document.getElementById(this.componentId+"_modal");t&&t.remove(),this.modalLoaded=!1}};