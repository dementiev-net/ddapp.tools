BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.ExportManager=function(t){this.params=t||{},this.exportButton=null,this.messageWrap=null,this.messageOk=null,this.messageProgressA=null,this.messageProgressB=null,this.messageProgressC=null,this.messageError=null,this.messageFile=null,this.isExporting=!1,this.progressSize=500,this.exported=0,this.total=0,this.errorsCount=0,this.currentStep=0,this.sessid=BX.bitrix_sessid(),this.init()},BX.DDAPP.Tools.ExportManager.prototype={init:function(){console.log("ExportManager: Params",this.params),this.initElements(),this.bindEvents(),this.initBeforeUnload()},initElements:function(){return this.exportButton=BX(this.params.buttonId)||document.getElementById(this.params.buttonSelector||"btn_export"),this.messageWrap=BX(this.params.messageWrapId||"export_message"),this.messageOk=BX(this.params.messageOkId||"export_message_ok"),this.messageProgressA=BX(this.params.messageProgressAId||"progress_percent_a"),this.messageProgressB=BX(this.params.messageProgressAId||"progress_percent_b"),this.messageProgressC=BX(this.params.messageProgressAId||"progress_percent_c"),this.messageError=BX(this.params.messageErrorId||"export_message_error"),this.messageFile=BX(this.params.messageFileId||"export_message_file"),this.exportButton?!!this.messageWrap||(console.warn("ExportManager: Message elements not found"),!1):(console.warn("ExportManager: Export button not found"),!1)},bindEvents:function(){this.exportButton&&BX.bind(this.exportButton,"click",BX.proxy(this.onExportClick,this))},initBeforeUnload:function(){BX.bind(window,"beforeunload",BX.proxy(this.onBeforeUnload,this))},onExportClick:function(t){t.preventDefault();var s=document.querySelector('[name="profile_id"]');s&&s.value&&this.startExport()},onBeforeUnload:function(t){if(this.isExporting)return t.preventDefault(),t.returnValue=BX.message("DDAPP_EXPORT_MESSAGE_BEFORE_UNLOAD"),t.returnValue},startExport:function(){this.isExporting=!0,this.exported=0,this.total=0,this.errorsCount=0,this.currentStep=0,this.setButtonState(!0),this.showProgress(),this.resetMessages(),this.exportStep(0)},exportStep:function(t){var s=this,e=this.getAjaxData(t)||{};e.sessid=this.sessid,console.log("ExportManager: AJAX",e),BX.ajax({url:this.getAjaxUrl(),method:"POST",dataType:"json",timeout:this.params.timeout||60,data:e,onsuccess:function(e){s.handleResponse(e,t)},onfailure:function(t){s.handleFailure(t)}})},getAjaxUrl:function(){return this.params.ajaxUrl||window.location.href},getAjaxData:function(t){return{step:t,totalExported:this.exported,exportId:this.getExportId(),sessid:BX.bitrix_sessid(),action:this.params.action||"export"}},getExportId:function(){if(this.params.exportId)return this.params.exportId;if(this.exportButton&&this.exportButton.dataset.exportId)return this.exportButton.dataset.exportId;var t=document.querySelector('[name="profile_id"]');return t?t.value:0},handleResponse:function(t,s){if(t)switch(t.status){case"processing":this.handleProcessing(t,s);break;case"done":this.handleDone(t);break;case"error":this.finishExport(t.message||BX.message("DDAPP_EXPORT_MESSAGE_UNKNOWN_ERROR"));break;default:this.finishExport(BX.message("DDAPP_EXPORT_MESSAGE_UNKNOWN_STATUS")+": "+t.status)}else this.finishExport(BX.message("DDAPP_EXPORT_MESSAGE_WRONG_SERVER_RESPONSE"))},handleProcessing:function(t,s){this.updateCounters(t),this.updateProgress();var e=this,r=this.params.stepDelay||100;setTimeout(function(){e.exportStep(s+1)},r)},handleDone:function(t){this.updateCounters(t),this.updateProgress(),this.showFileLink(t),this.finishExport()},handleFailure:function(t){console.error("ExportManager: AJAX Error",t),this.finishExport(BX.message("DDAPP_EXPORT_MESSAGE_ERROR_SERVER_CONNECT")+" (HTTP "+(t.status||"unknown")+")")},updateCounters:function(t){this.exported=parseInt(t.exported)||0,this.total=parseInt(t.total)||0,this.errorsCount=parseInt(t.errorsCount)||0},updateProgress:function(){var t=this.exported+" "+BX.message("DDAPP_EXPORT_SETTINGS_FROM")+" "+this.total;if(this.total>0){var s=Math.round(this.exported/this.total*100);this.messageProgressA.style.width=this.calculatePercent(s)+"px",this.messageProgressB.textContent=s+"%",this.messageProgressC.textContent=s+"%"}this.messageOk.textContent=t,this.messageError.textContent=this.errorsCount.toString()},showFileLink:function(t){if(t.fileUrl){var s=t.fileName||t.fileUrl.split("/").pop(),e=BX.message("DDAPP_EXPORT_SETTINGS_FILE")+': <a href="'+BX.util.htmlspecialchars(t.fileUrl)+'" target="_blank">'+BX.util.htmlspecialchars(s)+"</a>";this.messageFile.innerHTML=e}},finishExport:function(t){this.isExporting=!1,this.setButtonState(!1),t&&this.showError(t),this.onExportComplete()},setButtonState:function(t){this.exportButton&&(this.exportButton.disabled=t,t?this.exportButton.classList.add("ui-btn-wait"):this.exportButton.classList.remove("ui-btn-wait"))},showProgress:function(){this.messageWrap&&(this.messageWrap.style.display="block")},resetMessages:function(){this.messageOk&&(this.messageOk.textContent="0 "+BX.message("DDAPP_EXPORT_SETTINGS_FROM")+" 0"),this.messageProgressA&&(this.messageProgressA.style.width="0px"),this.messageProgressB&&(this.messageProgressB.textContent="0%"),this.messageProgressC&&(this.messageProgressC.textContent="0%"),this.messageError&&(this.messageError.textContent="0",this.messageError.style.color=""),this.messageFile&&(this.messageFile.innerHTML="")},showError:function(t){this.messageError&&(this.messageError.textContent=t,this.messageError.style.fontWeight="normal",this.messageError.style.color="red")},onExportComplete:function(){console.log("ExportManager: Export completed - Exported:",this.exported,"Total:",this.total,"Errors:",this.errorsCount)},start:function(){this.isExporting||this.startExport()},isRunning:function(){return this.isExporting},getProgress:function(){return{exported:this.exported,total:this.total,errorsCount:this.errorsCount,percent:this.total>0?Math.round(this.exported/this.total*100):0}},calculatePercent:function(t){return Math.round(this.progressSize*t/100)}};