BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.ImportProfileManager=function(e){this.params=e||{},this.currentProfileId=null,this.availableFields=[],this.ajaxUrl=e&&e.ajaxUrl?e.ajaxUrl:window.location.href,this.sessid=BX.bitrix_sessid(),this.init()},BX.DDAPP.Tools.ImportProfileManager.prototype={init:function(){console.log("ImportProfileManager: Params",this.params),this.toggleButtons(!1),this.bindEvents(),this.loadProfiles(""),this.loadIblockTypes()},bindEvents:function(){var e=this,t=document.getElementById("profile_select");t?BX.bind(t,"change",function(){this.value?e.loadProfile(this.value):(e.resetForm(),e.toggleSettings(!1),e.toggleFieldsSelection(!1))}):console.warn("ImportProfileManager: Select profiles not found");var o=document.getElementById("create_profile_btn");o&&BX.bind(o,"click",function(){e.createNewProfile()});var l=document.getElementById("delete_profile_btn");l&&BX.bind(l,"click",function(){e.deleteProfile()});var i=document.getElementById("iblock_type_select");i&&BX.bind(i,"change",function(){e.loadIblocks(this.value)});var n=document.getElementById("iblock_select");n&&BX.bind(n,"change",function(){this.value?e.loadIblockFields(this.value):e.toggleFieldsSelection(!1)});var r=document.getElementById("select_all_fields");r&&BX.bind(r,"click",function(){e.selectAllFields(!0)});var a=document.getElementById("deselect_all_fields");a&&BX.bind(a,"click",function(){e.selectAllFields(!1)});var s=document.getElementById("data_import_form");s&&BX.bind(s,"submit",function(t){BX.PreventDefault(t),e.saveProfile()});var c=document.getElementById("cancel_btn");c&&BX.bind(c,"click",function(){e.toggleSettings(!1),e.resetForm()})},createNewProfile:function(){this.currentProfileId=null,this.resetForm(),this.toggleButtons(!0),this.toggleSettings(!0)},loadProfiles:function(e){var t=this;BX.showWait(),this.makeRequest("get_profiles",{},function(t){BX.closeWait();var o=document.getElementById("profile_select");o&&(o.innerHTML='<option value="">'+BX.message("DDAPP_IMPORT_SETTINGS_PROFILE_SELECT")+"</option>",t.data&&t.data.length&&t.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,o.appendChild(t)}),e&&(o.value=e))},function(e){BX.closeWait(),t.showError(BX.message("DDAPP_IMPORT_MESSAGE_PROFILE_ERROR")),console.error("ImportProfileManager: Load Profile Error",e)})},loadProfile:function(e){var t=this;BX.showWait(),this.makeRequest("get_profile",{profile_id:e},function(o){var l=o.data;t.toggleButtons(!0),t.currentProfileId=e,t.fillForm(l),t.toggleSettings(!0),l.IBLOCK_TYPE_ID?t.loadIblocks(l.IBLOCK_TYPE_ID,function(){var e=document.getElementById("iblock_select");e&&(e.value=l.IBLOCK_ID),l.IBLOCK_ID?t.loadIblockFields(l.IBLOCK_ID,function(){t.fillImportSettings(l.SETTINGS),BX.closeWait()}):BX.closeWait()}):BX.closeWait()},function(e){BX.closeWait(),t.showError(BX.message("DDAPP_IMPORT_MESSAGE_PROFILE_ERROR")),console.error("ImportProfileManager: Load Profile Error",e)})},deleteProfile:function(){var e=this,t=document.getElementById("profile_select");if(!t)return;var o=t.value;if(!o)return void this.showAlert(BX.message("DDAPP_IMPORT_MESSAGE_PROFILE_SELECT_ERROR"));BX.UI.Dialogs.MessageBox.create({message:BX.message("DDAPP_IMPORT_MESSAGE_BEFORE_DELETE"),title:BX.message("DDAPP_IMPORT_MESSAGE_TITLE"),buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:function(t){e.doDeleteProfile(o),t.close()}}).show()},doDeleteProfile:function(e){var t=this;BX.showWait(),this.makeRequest("delete_profile",{profile_id:e},function(){BX.closeWait(),t.loadProfiles(""),t.toggleSettings(!1),t.resetForm(),t.showAlert(BX.message("DDAPP_IMPORT_MESSAGE_PROFILE_DELETE"))},function(e){BX.closeWait(),t.showError(BX.message("DDAPP_IMPORT_MESSAGE_PROFILE_DELETE_ERROR")),console.error("ImportProfileManager: Delete Profile Error",e)})},loadIblockTypes:function(){var e=this;this.makeRequest("get_iblock_types",{},function(e){var t=document.getElementById("iblock_type_select");t&&(t.innerHTML='<option value="">'+BX.message("DDAPP_IMPORT_SETTINGS_IBLOCK_TYPE_SELECT")+"</option>",e.data&&e.data.length&&e.data.forEach(function(e){var o=document.createElement("option");o.value=e.ID,o.textContent=e.NAME||e.ID,t.appendChild(o)}))},function(t){e.showError(BX.message("DDAPP_IMPORT_MESSAGE_IBLOCK_TYPE_ERROR")),console.error("ImportProfileManager: Load Profile Type Error",t)})},loadIblocks:function(e,t){var o=document.getElementById("iblock_select");if(o)return e?void this.makeRequest("get_iblocks",{type_id:e},function(e){o.innerHTML='<option value="">'+BX.message("DDAPP_IMPORT_SETTINGS_IBLOCK_SELECT")+"</option>",e.data&&e.data.length&&e.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,o.appendChild(t)}),o.disabled=!1,t&&t()},function(e){console.error("ImportProfileManager: Load Profile Error",e)}):(o.innerHTML='<option value="">'+BX.message("DDAPP_IMPORT_SETTINGS_IBLOCK_SELECT_FIRST")+"</option>",o.disabled=!0,void this.toggleFieldsSelection(!1))},loadIblockFields:function(e,t){var o=this;e?this.makeRequest("get_iblock_fields",{iblock_id:e},function(e){o.availableFields=e.data,o.renderFieldsSelection(),o.toggleFieldsSelection(!0),t&&t()},function(e){console.error("ImportProfileManager: Load Iblock Fields Error",e)}):this.toggleFieldsSelection(!1)},saveProfile:function(){var e=this,t=document.getElementById("data_import_form");if(t){var o=this.validateFieldsAndCells();if(o)this.showError(o);else{var l=new FormData(t),i={};for(var n of l.entries()){var r=n[0],a=n[1];0!==r.indexOf("settings[")&&(i[r]=a)}var s={},c=[],d={},u=document.getElementById("fields_container");if(u)u.querySelectorAll(".field-item").forEach(function(e){var t=e.querySelector('input[type="checkbox"]'),o=e.querySelector('input[type="text"]');t&&t.checked&&(c.push(t.value),o&&o.value&&(d[t.value]=o.value))});for(var n of l.entries()){r=n[0],a=n[1];if(0===r.indexOf("settings[")&&"settings[import_fields][]"!==r){var f=r.match(/settings\[(.+)\]/)[1];s[f]=a}}c.length>0&&(s.import_fields=c,s.import_cells=d),t.querySelectorAll('input[type="checkbox"][name^="settings["]').forEach(function(e){if("settings[import_fields][]"!==e.name){var t=e.name.match(/settings\[(.+)\]/)[1];void 0===s[t]&&(s[t]=e.checked?"Y":"N")}}),i.settings=s,i.action="save_profile",BX.showWait(),this.makeRequest("save_profile",i,function(t){if(BX.closeWait(),e.showAlert(t.message),!e.currentProfileId&&t.id){e.currentProfileId=t.id;var o=document.getElementById("profile_id");o&&(o.value=t.id)}e.loadProfiles(e.currentProfileId)},function(t){BX.closeWait(),e.showError(BX.message("DDAPP_IMPORT_MESSAGE_PROFILE_SAVE_ERROR")),console.error("ImportProfileManager: Save Profile Error",t)})}}},makeRequest:function(e,t,o,l){(t=t||{}).action=e,t.sessid=this.sessid,BX.ajax({url:this.ajaxUrl,method:"POST",data:t,dataType:"json",onsuccess:function(e){e&&e.success?o&&o(e):l&&(console.error("ImportProfileManager: Connect Error",e),l(e&&e.message?e.message:BX.message("DDAPP_IMPORT_MESSAGE_ERROR_SERVER_CONNECT")))},onfailure:function(e){l&&(console.error("ImportProfileManager: Connect Error",e),l(BX.message("DDAPP_IMPORT_MESSAGE_ERROR_SERVER_CONNECT")))}})},renderFieldsSelection:function(){var e=document.getElementById("fields_container");if(e){e.innerHTML="";var t={FIELD:BX.message("DDAPP_IMPORT_SETTINGS_IBLOCK_FIELD"),PROPERTY:BX.message("DDAPP_IMPORT_SETTINGS_IBLOCK_PROPERTY")},o=this;Object.keys(t).forEach(function(l){var i=o.availableFields.filter(function(e){return e.TYPE===l});if(0!==i.length){var n=document.createElement("div");n.className="field-group";var r=document.createElement("h3");r.textContent=t[l],n.appendChild(r);var a=document.createElement("div");a.className="sortable-container",a.setAttribute("data-group",l),i.forEach(function(e){var t=document.createElement("div");t.className="field-item",t.setAttribute("data-field-code",e.CODE);var o=document.createElement("input");o.type="checkbox",o.name="settings[import_fields][]",o.value=e.CODE,o.id="field_"+e.CODE,o.className="field-checkbox";var l=document.createElement("input");l.type="text",l.value="",l.id="cell_"+e.CODE,l.className="field-input",l.placeholder="A1";var i=document.createElement("label");i.setAttribute("for","field_"+e.CODE),i.textContent=e.NAME+" ["+e.CODE+"]",i.className="field-label",i.style.flex="1";var n=document.createElement("label");n.setAttribute("for","cell_"+e.CODE),n.textContent="ячейка",n.className="field-label",t.appendChild(o),t.appendChild(i),t.appendChild(l),t.appendChild(n),a.appendChild(t)}),n.appendChild(a),e.appendChild(n)}})}},toggleFieldsSelection:function(e){document.querySelectorAll(".fields-selection").forEach(function(t){t.style.display=e?"table-row":"none"})},selectAllFields:function(e){document.querySelectorAll('input[name="settings[import_fields][]"]').forEach(function(t){t.checked=e})},fillForm:function(e){var t=document.getElementById("profile_id");t&&(t.value=e.ID);var o=document.getElementById("profile_name");o&&(o.value=e.NAME);var l=document.getElementById("iblock_type_select");l&&(l.value=e.IBLOCK_TYPE_ID||"")},fillImportSettings:function(e){if(e)try{var t=JSON.parse(e);console.log("ImportProfileManager: Profile settings",t),"string"==typeof t&&(t=JSON.parse(t));var o=this;"object"!=typeof t||Array.isArray(t)||Object.keys(t).forEach(function(e){if("import_fields"===e&&Array.isArray(t[e]))o.restoreFields(t[e],t.import_cells);else if("import_cells"===e);else{var l=document.querySelector('[name="settings['+e+']"]');l&&("checkbox"===l.type?l.checked="Y"===t[e]:l.value=t[e])}})}catch(e){console.error("ImportProfileManager: Settings Parser Error",e)}},toggleSettings:function(e){if(document.querySelectorAll(".profile-settings").forEach(function(t){t.style.display=e?"table-row":"none"}),!e){var t=document.getElementById("profile_select");t&&(t.value="")}},toggleButtons:function(e){["submit_btn","cancel_btn"].forEach(t=>{const o=document.getElementById(t);o&&(o.disabled=!e)})},resetForm:function(){var e=document.getElementById("data_import_form");e&&e.reset&&e.reset();var t=document.getElementById("profile_id");t&&(t.value="");var o=document.getElementById("iblock_select");o&&(o.innerHTML='<option value="">'+BX.message("DDAPP_IMPORT_SETTINGS_IBLOCK_SELECT_FIRST")+"</option>",o.disabled=!0),this.toggleButtons(!1),this.toggleSettings(!1),this.toggleFieldsSelection(!1),this.currentProfileId=null,this.availableFields=[]},restoreFields:function(e,t){if(e&&Array.isArray(e)){e.forEach(function(e){var o=document.querySelector('input[value="'+e+'"]');if(o&&(o.checked=!0),t&&t[e]){var l=document.querySelector('input[id="cell_'+e+'"]');l&&(l.value=t[e])}})}},validateFieldsAndCells:function(){var e=document.getElementById("fields_container");if(!e)return null;var t=e.querySelectorAll(".field-item"),o=[];return t.forEach(function(e){var t=e.querySelector('input[type="text"]');t&&(t.style.border="")}),t.forEach(function(e){var t=e.querySelector('input[type="checkbox"]'),l=e.querySelector('input[type="text"]');if(t&&t.checked&&(!l||!l.value.trim())){var i=e.querySelector(".field-label"),n=i?i.textContent:t.value;o.push(n),l&&(l.style.border="1px solid red")}}),o.length>0?BX.message("DDAPP_IMPORT_MESSAGE_IBLOCK_FIELD_VALIDATION_ERROR")+o.join(", "):null},showAlert:function(e){BX.UI.Dialogs.MessageBox.alert(e,BX.message("DDAPP_IMPORT_MESSAGE_TITLE"))},showError:function(e){BX.UI.Dialogs.MessageBox.alert(e,BX.message("DDAPP_IMPORT_MESSAGE_ERROR"))}};