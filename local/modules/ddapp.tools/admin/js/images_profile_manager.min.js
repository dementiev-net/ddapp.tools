BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.ImagesProfileManager=function(e){this.params=e||{},this.currentProfileId=null,this.availableFields=[],this.ajaxUrl=e&&e.ajaxUrl?e.ajaxUrl:window.location.href,this.sessid=BX.bitrix_sessid(),this.init()},BX.DDAPP.Tools.ImagesProfileManager.prototype={init:function(){console.log("ImagesProfileManager: Params",this.params),this.toggleButtons(!1),this.bindEvents(),this.loadProfiles(""),this.loadIblockTypes()},bindEvents:function(){var e=this,t=document.getElementById("profile_select");t?BX.bind(t,"change",function(){this.value?e.loadProfile(this.value):(e.resetForm(),e.toggleSettings(!1),e.toggleFieldsSelection(!1))}):console.warn("ImagesProfileManager: Select profiles not found");var o=document.getElementById("create_profile_btn");o&&BX.bind(o,"click",function(){e.createNewProfile()});var n=document.getElementById("delete_profile_btn");n&&BX.bind(n,"click",function(){e.deleteProfile()});var i=document.getElementById("iblock_type_select");i&&BX.bind(i,"change",function(){e.loadIblocks(this.value)});var l=document.getElementById("iblock_select");l&&BX.bind(l,"change",function(){this.value?e.loadIblockFields(this.value):e.toggleFieldsSelection(!1)});var a=document.getElementById("data_images_form");a&&BX.bind(a,"submit",function(t){BX.PreventDefault(t),e.saveProfile()});var s=document.getElementById("cancel_btn");s&&BX.bind(s,"click",function(){e.toggleSettings(!1),e.resetForm()})},createNewProfile:function(){this.currentProfileId=null,this.resetForm(),this.toggleButtons(!0),this.toggleSettings(!0)},loadProfiles:function(e){var t=this;BX.showWait(),this.makeRequest("get_profiles",{},function(t){BX.closeWait();var o=document.getElementById("profile_select");o&&(o.innerHTML='<option value="">'+BX.message("DDAPP_IMAGES_SETTINGS_PROFILE_SELECT")+"</option>",t.data&&t.data.length&&t.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,o.appendChild(t)}),e&&(o.value=e))},function(e){BX.closeWait(),t.showError(BX.message("DDAPP_IMAGES_MESSAGE_PROFILE_ERROR")),console.error("ImagesProfileManager: Load Profile Error",e)})},loadProfile:function(e){var t=this;BX.showWait(),this.makeRequest("get_profile",{profile_id:e},function(o){var n=o.data;t.toggleButtons(!0),t.currentProfileId=e,t.fillForm(n),t.toggleSettings(!0),n.IBLOCK_TYPE_ID?t.loadIblocks(n.IBLOCK_TYPE_ID,function(){var e=document.getElementById("iblock_select");e&&(e.value=n.IBLOCK_ID),n.IBLOCK_ID?t.loadIblockFields(n.IBLOCK_ID,function(){t.fillImagesSettings(n.SETTINGS),BX.closeWait()}):BX.closeWait()}):BX.closeWait()},function(e){BX.closeWait(),t.showError(BX.message("DDAPP_IMAGES_MESSAGE_PROFILE_ERROR")),console.error("ImagesProfileManager: Load Profile Error",e)})},deleteProfile:function(){var e=this,t=document.getElementById("profile_select");if(!t)return;var o=t.value;if(!o)return void this.showAlert(BX.message("DDAPP_IMAGES_MESSAGE_PROFILE_SELECT_ERROR"));BX.UI.Dialogs.MessageBox.create({message:BX.message("DDAPP_IMAGES_MESSAGE_BEFORE_DELETE"),title:BX.message("DDAPP_IMAGES_MESSAGE_TITLE"),buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:function(t){e.doDeleteProfile(o),t.close()}}).show()},doDeleteProfile:function(e){var t=this;BX.showWait(),this.makeRequest("delete_profile",{profile_id:e},function(){BX.closeWait(),t.loadProfiles(""),t.toggleSettings(!1),t.resetForm(),t.showAlert(BX.message("DDAPP_IMAGES_MESSAGE_PROFILE_DELETE"))},function(e){BX.closeWait(),t.showError(BX.message("DDAPP_IMAGES_MESSAGE_PROFILE_DELETE_ERROR")),console.error("ImagesProfileManager: Delete Profile Error",e)})},loadIblockTypes:function(){var e=this;this.makeRequest("get_iblock_types",{},function(e){var t=document.getElementById("iblock_type_select");t&&(t.innerHTML='<option value="">'+BX.message("DDAPP_IMAGES_SETTINGS_IBLOCK_TYPE_SELECT")+"</option>",e.data&&e.data.length&&e.data.forEach(function(e){var o=document.createElement("option");o.value=e.ID,o.textContent=e.NAME||e.ID,t.appendChild(o)}))},function(t){e.showError(BX.message("DDAPP_IMAGES_MESSAGE_IBLOCK_TYPE_ERROR")),console.error("ImagesProfileManager: Load Profile Type Error",t)})},loadIblocks:function(e,t){var o=document.getElementById("iblock_select");if(o)return e?void this.makeRequest("get_iblocks",{type_id:e},function(e){o.innerHTML='<option value="">'+BX.message("DDAPP_IMAGES_SETTINGS_IBLOCK_SELECT")+"</option>",e.data&&e.data.length&&e.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,o.appendChild(t)}),o.disabled=!1,t&&t()},function(e){console.error("ImagesProfileManager: Load Profile Error",e)}):(o.innerHTML='<option value="">'+BX.message("DDAPP_IMAGES_SETTINGS_IBLOCK_SELECT_FIRST")+"</option>",o.disabled=!0,void this.toggleFieldsSelection(!1))},loadIblockFields:function(e,t){var o=this;e?this.makeRequest("get_iblock_fields",{iblock_id:e},function(e){o.availableFields=e.data,o.renderFieldsSelection(),o.toggleFieldsSelection(!0),t&&t()},function(e){console.error("ImagesProfileManager: Load Iblock Fields Error",e)}):this.toggleFieldsSelection(!1)},saveProfile:function(){var e=this,t=document.getElementById("data_images_form");if(t){var o=new FormData(t),n={};for(var i of o.entries()){var l=i[0],a=i[1];0!==l.indexOf("settings[")&&(n[l]=a)}var s={};for(var i of o.entries()){l=i[0],a=i[1];if(0===l.indexOf("settings["))s[l.match(/settings\[(.+)\]/)[1]]=a}n.settings=s,n.action="save_profile",BX.showWait(),this.makeRequest("save_profile",n,function(t){if(BX.closeWait(),e.showAlert(t.message),!e.currentProfileId&&t.id){e.currentProfileId=t.id;var o=document.getElementById("profile_id");o&&(o.value=t.id)}e.loadProfiles(e.currentProfileId)},function(t){BX.closeWait(),e.showError(BX.message("DDAPP_IMAGES_MESSAGE_PROFILE_SAVE_ERROR")),console.error("ImagesProfileManager: Save Profile Error",t)})}},makeRequest:function(e,t,o,n){(t=t||{}).action=e,t.sessid=this.sessid,BX.ajax({url:this.ajaxUrl,method:"POST",data:t,dataType:"json",onsuccess:function(e){e&&e.success?o&&o(e):n&&(console.error("ImagesProfileManager: Connect Error",e),n(e&&e.message?e.message:BX.message("DDAPP_IMAGES_MESSAGE_ERROR_SERVER_CONNECT")))},onfailure:function(e){n&&(console.error("ImagesProfileManager: Connect Error",e),n(BX.message("DDAPP_IMAGES_MESSAGE_ERROR_SERVER_CONNECT")))}})},renderFieldsSelection:function(){var e={FIELD:BX.message("DDAPP_IMAGES_SETTINGS_IBLOCK_FIELD"),PROPERTY:BX.message("DDAPP_IMAGES_SETTINGS_IBLOCK_PROPERTY")},t=this;Object.keys(e).forEach(function(e){var o=t.availableFields.filter(function(t){return t.TYPE===e});if(0!==o.length){var n=document.getElementById("images_field");n&&o.forEach(function(e){var t=document.createElement("option");t.value=e.CODE,t.textContent=e.NAME+" ["+e.CODE+"]",n.appendChild(t)})}})},toggleFieldsSelection:function(e){document.querySelectorAll(".fields-selection").forEach(function(t){t.style.display=e?"table-row":"none"})},fillForm:function(e){var t=document.getElementById("profile_id");t&&(t.value=e.ID);var o=document.getElementById("profile_name");o&&(o.value=e.NAME);var n=document.getElementById("iblock_type_select");n&&(n.value=e.IBLOCK_TYPE_ID||"");var i=document.getElementById("zip_file");i&&(i.value=e.ZIP_FILE||"")},fillImagesSettings:function(e){if(e)try{var t=JSON.parse(e);console.log("ImagesProfileManager: Profile settings",t),"string"==typeof t&&(t=JSON.parse(t));"object"!=typeof t||Array.isArray(t)||Object.keys(t).forEach(function(e){var o=document.querySelector('[name="settings['+e+']"]');o&&(o.value=t[e])})}catch(e){console.error("ImagesProfileManager: Settings Parser Error",e)}},toggleSettings:function(e){if(document.querySelectorAll(".profile-settings").forEach(function(t){t.style.display=e?"table-row":"none"}),!e){var t=document.getElementById("profile_select");t&&(t.value="")}},toggleButtons:function(e){["submit_btn","cancel_btn"].forEach(t=>{const o=document.getElementById(t);o&&(o.disabled=!e)})},resetForm:function(){var e=document.getElementById("data_images_form");e&&e.reset&&e.reset();var t=document.getElementById("profile_id");t&&(t.value="");var o=document.getElementById("iblock_select");o&&(o.innerHTML='<option value="">'+BX.message("DDAPP_IMAGES_SETTINGS_IBLOCK_SELECT_FIRST")+"</option>",o.disabled=!0),this.toggleButtons(!1),this.toggleSettings(!1),this.toggleFieldsSelection(!1),this.currentProfileId=null,this.availableFields=[]},showAlert:function(e){BX.UI.Dialogs.MessageBox.alert(e,BX.message("DDAPP_IMAGES_MESSAGE_TITLE"))},showError:function(e){BX.UI.Dialogs.MessageBox.alert(e,BX.message("DDAPP_IMAGES_MESSAGE_ERROR"))}};