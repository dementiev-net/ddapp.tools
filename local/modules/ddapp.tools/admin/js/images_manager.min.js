BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.ImagesManager=function(s){this.params=s||{},this.uploadButton=null,this.messageWrap=null,this.messageOk=null,this.messageProgressA=null,this.messageProgressB=null,this.messageProgressC=null,this.messageError=null,this.messageFile=null,this.isUploading=!1,this.progressSize=500,this.uploaded=0,this.total=0,this.errorsCount=0,this.currentStep=0,this.sessid=BX.bitrix_sessid(),this.init()},BX.DDAPP.Tools.ImagesManager.prototype={init:function(){console.log("ImagesManager: Params",this.params),this.initElements(),this.bindEvents(),this.initBeforeUnload()},initElements:function(){return this.uploadButton=BX(this.params.buttonId)||document.getElementById(this.params.buttonSelector||"btn_upload"),this.messageWrap=BX(this.params.messageWrapId||"upload_message"),this.messageOk=BX(this.params.messageOkId||"upload_message_ok"),this.messageProgressA=BX(this.params.messageProgressAId||"progress_percent_a"),this.messageProgressB=BX(this.params.messageProgressAId||"progress_percent_b"),this.messageProgressC=BX(this.params.messageProgressAId||"progress_percent_c"),this.messageError=BX(this.params.messageErrorId||"upload_message_error"),this.messageFile=BX(this.params.messageFileId||"upload_message_file"),this.uploadButton?!!this.messageWrap||(console.warn("ImagesManager: Message elements not found"),!1):(console.warn("ImagesManager: Upload button not found"),!1)},bindEvents:function(){this.uploadButton&&BX.bind(this.uploadButton,"click",BX.proxy(this.onUploadClick,this))},initBeforeUnload:function(){BX.bind(window,"beforeunload",BX.proxy(this.onBeforeUnload,this))},onUploadClick:function(s){s.preventDefault();var t=document.querySelector('[name="profile_id"]');t&&t.value&&this.startUpload()},onBeforeUnload:function(s){if(this.isUploading)return s.preventDefault(),s.returnValue=BX.message("DDAPP_IMAGES_MESSAGE_BEFORE_UNLOAD"),s.returnValue},startUpload:function(){this.isUploading=!0,this.uploaded=0,this.total=0,this.errorsCount=0,this.currentStep=0,this.setButtonState(!0),this.showProgress(),this.resetMessages(),this.uploadStep(0)},uploadStep:function(s){var t=this,e=this.getAjaxData(s)||{};e.sessid=this.sessid,console.log("ImagesManager: AJAX",e),BX.ajax({url:this.getAjaxUrl(),method:"POST",dataType:"json",timeout:this.params.timeout||60,data:e,onsuccess:function(e){t.handleResponse(e,s)},onfailure:function(s){t.handleFailure(s)}})},getAjaxUrl:function(){return this.params.ajaxUrl||window.location.href},getAjaxData:function(s){return{step:s,totalUploaded:this.uploaded,uploadId:this.getUploadId(),sessid:BX.bitrix_sessid(),action:this.params.action||"upload"}},getUploadId:function(){if(this.params.uploadId)return this.params.uploadId;if(this.uploadButton&&this.uploadButton.dataset.uploadId)return this.uploadButton.dataset.uploadId;var s=document.querySelector('[name="profile_id"]');return s?s.value:0},handleResponse:function(s,t){if(s)switch(s.status){case"processing":this.handleProcessing(s,t);break;case"done":this.handleDone(s);break;case"error":this.finishUpload(s.message||BX.message("DDAPP_IMAGES_MESSAGE_UNKNOWN_ERROR"));break;default:this.finishUpload(BX.message("DDAPP_IMAGES_MESSAGE_UNKNOWN_STATUS")+": "+s.status)}else this.finishUpload(BX.message("DDAPP_IMAGES_MESSAGE_WRONG_SERVER_RESPONSE"))},handleProcessing:function(s,t){this.updateCounters(s),this.updateProgress();var e=this,a=this.params.stepDelay||100;setTimeout(function(){e.uploadStep(t+1)},a)},handleDone:function(s){this.updateCounters(s),this.updateProgress(),this.showFileLink(s),this.finishUpload()},handleFailure:function(s){console.error("ImagesManager: AJAX Error",s),this.finishUpload(BX.message("DDAPP_IMAGES_MESSAGE_ERROR_SERVER_CONNECT")+" (HTTP "+(s.status||"unknown")+")")},updateCounters:function(s){this.uploaded=parseInt(s.uploaded)||0,this.total=parseInt(s.total)||0,this.errorsCount=parseInt(s.errorsCount)||0},updateProgress:function(){var s=this.uploaded+" "+BX.message("DDAPP_IMAGES_SETTINGS_FROM")+" "+this.total;if(this.total>0){var t=Math.round(this.uploaded/this.total*100);this.messageProgressA.style.width=this.calculatePercent(t)+"px",this.messageProgressB.textContent=t+"%",this.messageProgressC.textContent=t+"%"}this.messageOk.textContent=s,this.messageError.textContent=this.errorsCount.toString()},showFileLink:function(s){if(s.fileUrl){var t=s.fileName||s.fileUrl.split("/").pop(),e=BX.message("DDAPP_IMAGES_SETTINGS_FILE")+': <a href="'+BX.util.htmlspecialchars(s.fileUrl)+'" target="_blank">'+BX.util.htmlspecialchars(t)+"</a>";this.messageFile.innerHTML=e}},finishUpload:function(s){this.isUploading=!1,this.setButtonState(!1),s&&this.showError(s),this.onUploadComplete()},setButtonState:function(s){this.uploadButton&&(this.uploadButton.disabled=s,s?this.uploadButton.classList.add("ui-btn-wait"):this.uploadButton.classList.remove("ui-btn-wait"))},showProgress:function(){this.messageWrap&&(this.messageWrap.style.display="block")},resetMessages:function(){this.messageOk&&(this.messageOk.textContent="0 "+BX.message("DDAPP_IMAGES_SETTINGS_FROM")+" 0"),this.messageProgressA&&(this.messageProgressA.style.width="0px"),this.messageProgressB&&(this.messageProgressB.textContent="0%"),this.messageProgressC&&(this.messageProgressC.textContent="0%"),this.messageError&&(this.messageError.textContent="0",this.messageError.style.color=""),this.messageFile&&(this.messageFile.innerHTML="")},showError:function(s){this.messageError&&(this.messageError.textContent=s,this.messageError.style.fontWeight="normal",this.messageError.style.color="red")},onUploadComplete:function(){console.log("ImagesManager: Upload completed - Uploaded:",this.uploaded,"Total:",this.total,"Errors:",this.errorsCount)},start:function(){this.isUploading||this.startUpload()},isRunning:function(){return this.isUploading},getProgress:function(){return{uploaded:this.uploaded,total:this.total,errorsCount:this.errorsCount,percent:this.total>0?Math.round(this.uploaded/this.total*100):0}},calculatePercent:function(s){return Math.round(this.progressSize*s/100)}};