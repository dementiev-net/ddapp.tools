BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.ImportExcelManager=function(e){this.params=e||{},this.iblockId=e.iblockId||null,this.settings=e.settings||{},this.properties=e.properties||{},this.currentDialog=null,this.init()},BX.DDAPP.Tools.ImportExcelManager.prototype={init:function(){console.log("ImportExcelManager: Params",this.params);var e=this;window.openExcelModal=function(){e.openModal()}},openModal:function(){var e=this;this.currentDialog=new BX.CDialog({title:this.params.modalMessageTitle,content:BX("excel_import_div").innerHTML,width:500,height:250,resizable:!0,draggable:!0,buttons:[{title:this.params.modalMessageBtnClose,id:"excel_import_close",name:"close",action:function(){this.parentWindow.Close()}}]}),this.currentDialog.Show(),setTimeout(function(){var r=document.querySelector(".bx-core-adm-dialog input[type=file]");r&&r.addEventListener("change",function(r){var t=r.target.files[0]?r.target.files[0].name:"",a=e.currentDialog.PARTS.CONTENT.querySelector("#file-name");a&&(a.textContent=t?e.params.modalMessageFile+t:""),e.handleExcelFile(r)})},100)},handleExcelFile:function(e){var r=this;BX.showWait();var t=e.target.files[0],a=new FileReader;a.onload=function(e){try{var t=new Uint8Array(e.target.result),a=XLSX.read(t,{type:"array"}),n=a.Sheets[a.SheetNames[0]];if(!r.settings||!r.settings.import_fields||!r.settings.import_cells)throw new Error("Import settings not found");var o=0,s=[];r.settings.import_fields.forEach(function(e){var t=r.settings.import_cells[e];if(t){var a=n[t]?n[t].v:"",i=r.getFieldSelector(e);if(i){var l=document.querySelector(i);l?(l.value=r.formatCellValue(a,e),o++):s.push(r.params.messageImportFieldError+e)}else s.push(r.params.messageImportSelectorError+e)}else s.push(r.params.messageImportCellError+e)}),r.currentDialog&&r.currentDialog.Close();var i=r.params.messageImport+o;s.length>0&&(i+="<br>"+s.join("<br>")),r.showAlert(i)}catch(e){r.currentDialog&&r.currentDialog.Close(),r.showError(r.params.messageFileImportError),console.error("ImportExcelManager File Import Error:",e.message)}finally{BX.closeWait()}},a.onerror=function(){BX.closeWait(),r.showError(r.params.messageFileReadtError),console.error("ImportExcelManager File Import Error: File Read Error")},a.readAsArrayBuffer(t)},getFieldSelector:function(e){switch(e){case"NAME":return'input[name="NAME"]';case"CODE":return'input[name="CODE"]';case"SORT":return'input[name="SORT"]';case"ACTIVE":return'input[name="ACTIVE"]';case"PREVIEW_TEXT":return'textarea[name="PREVIEW_TEXT"]';case"DETAIL_TEXT":return'textarea[name="DETAIL_TEXT"]';case"PREVIEW_PICTURE":return'input[name="PREVIEW_PICTURE"]';case"DETAIL_PICTURE":return'input[name="DETAIL_PICTURE"]';default:return this.getPropertySelector(e)}},getPropertySelector:function(e){if(this.properties&&this.properties[e])return'input[name="PROP['+(n=this.properties[e])+'][n0]"], textarea[name="PROP['+n+'][n0]"], select[name="PROP['+n+'][n0]"]';for(var r=document.querySelectorAll('input[name^="PROP["], textarea[name^="PROP["], select[name^="PROP["]'),t=0;t<r.length;t++){var a=(s=r[t]).name.match(/PROP\[(\d+)\]/);if(a){var n=a[1];for(var o in this.properties)if(this.properties[o]===n&&"PROPERTY_"+o===e)return'[name="'+s.name+'"]'}}var s,i=document.querySelector('[data-property-code="'+e+'"]');if(i&&((s=i.querySelector("input, textarea, select"))&&s.name))return'[name="'+s.name+'"]';return null},formatCellValue:function(e,r){if(null==e)return"";var t=String(e);return("number"==typeof e||/^\d+[,\.]\d+$/.test(t))&&(t=t.replace(",",".")),t},showAlert:function(e){BX.UI.Dialogs.MessageBox.alert(e,this.params.messageTitle)},showError:function(e){BX.UI.Dialogs.MessageBox.alert(e,this.params.messageError)}};