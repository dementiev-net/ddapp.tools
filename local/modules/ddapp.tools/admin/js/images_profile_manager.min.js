BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.ImagesProfileManager=function(e){this.params=e||{},this.currentProfileId=null,this.availableFields=[],this.ajaxUrl=e&&e.ajaxUrl?e.ajaxUrl:window.location.href,this.sessid=BX.bitrix_sessid(),this.init()},BX.DDAPP.Tools.ImagesProfileManager.prototype={init:function(){console.log("ImagesProfileManager: Params",this.params),this.toggleButtons(!1),this.bindEvents(),this.loadProfiles(""),this.loadIblockTypes()},bindEvents:function(){var e=this,t=document.getElementById("profile_select");t?BX.bind(t,"change",function(){this.value?e.loadProfile(this.value):(e.resetForm(),e.toggleSettings(!1),e.toggleFieldsSelection(!1))}):console.warn("ImagesProfileManager: Select profiles not found");var o=document.getElementById("create_profile_btn");o&&BX.bind(o,"click",function(){e.createNewProfile()});var r=document.getElementById("delete_profile_btn");r&&BX.bind(r,"click",function(){e.deleteProfile()});var i=document.getElementById("iblock_type_select");i&&BX.bind(i,"change",function(){e.loadIblocks(this.value)});var a=document.getElementById("iblock_select");a&&BX.bind(a,"change",function(){this.value?e.loadIblockFields(this.value):e.toggleFieldsSelection(!1)});var n=document.getElementById("data_images_form");n&&BX.bind(n,"submit",function(t){BX.PreventDefault(t),e.saveProfile()});var l=document.getElementById("cancel_btn");l&&BX.bind(l,"click",function(){e.toggleSettings(!1),e.resetForm()})},createNewProfile:function(){this.currentProfileId=null,this.resetForm(),this.toggleButtons(!0),this.toggleSettings(!0)},loadProfiles:function(e){var t=this;BX.showWait(),this.makeRequest("get_profiles",{},function(o){BX.closeWait();var r=document.getElementById("profile_select");r&&(r.innerHTML='<option value="">'+t.params.messageProfileSelect+"</option>",o.data&&o.data.length&&o.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,r.appendChild(t)}),e&&(r.value=e))},function(e){BX.closeWait(),t.showError(t.params.messageProfileLoadError),console.error("ImagesProfileManager: Load Profile Error",e)})},loadProfile:function(e){var t=this;BX.showWait(),this.makeRequest("get_profile",{profile_id:e},function(o){var r=o.data;t.toggleButtons(!0),t.currentProfileId=e,t.fillForm(r),t.toggleSettings(!0),r.IBLOCK_TYPE_ID?t.loadIblocks(r.IBLOCK_TYPE_ID,function(){var e=document.getElementById("iblock_select");e&&(e.value=r.IBLOCK_ID),r.IBLOCK_ID?t.loadIblockFields(r.IBLOCK_ID,function(){t.fillImagesSettings(r.SETTINGS),BX.closeWait()}):BX.closeWait()}):BX.closeWait()},function(e){BX.closeWait(),t.showError(t.params.messageProfileLoadError),console.error("ImagesProfileManager: Load Profile Error",e)})},deleteProfile:function(){var e=this,t=document.getElementById("profile_select");if(!t)return;var o=t.value;if(!o)return void this.showAlert(e.params.messageProfileSelectError);BX.UI.Dialogs.MessageBox.create({message:e.params.messageBeforeDelete,title:e.params.messageTitle,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:function(t){e.doDeleteProfile(o),t.close()}}).show()},doDeleteProfile:function(e){var t=this;BX.showWait(),this.makeRequest("delete_profile",{profile_id:e},function(){BX.closeWait(),t.loadProfiles(""),t.toggleSettings(!1),t.resetForm(),t.showAlert(t.params.messageProfileDeleteOk)},function(e){BX.closeWait(),t.showError(t.params.messageProfileDeleteError),console.error("ImagesProfileManager: Delete Profile Error",e)})},loadIblockTypes:function(){var e=this;this.makeRequest("get_iblock_types",{},function(t){var o=document.getElementById("iblock_type_select");o&&(o.innerHTML='<option value="">'+e.params.messageIblockTypeSelect+"</option>",t.data&&t.data.length&&t.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME||e.ID,o.appendChild(t)}))},function(t){e.showError(e.params.messageIblockSelectError),console.error("ImagesProfileManager: Load Profile Type Error",t)})},loadIblocks:function(e,t){var o=this,r=document.getElementById("iblock_select");if(r)return e?void this.makeRequest("get_iblocks",{type_id:e},function(e){r.innerHTML='<option value="">'+o.params.messageIblockSelect+"</option>",e.data&&e.data.length&&e.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,r.appendChild(t)}),r.disabled=!1,t&&t()},function(e){console.error("ImagesProfileManager: Load Profile Error",e)}):(r.innerHTML='<option value="">'+o.params.messageIblockTypeSelectFirst+"</option>",r.disabled=!0,void this.toggleFieldsSelection(!1))},loadIblockFields:function(e,t){var o=this;e?this.makeRequest("get_iblock_fields",{iblock_id:e},function(e){o.availableFields=e.data,o.renderFieldsSelection(),o.toggleFieldsSelection(!0),t&&t()},function(e){console.error("ImagesProfileManager: Load Iblock Fields Error",e)}):this.toggleFieldsSelection(!1)},saveProfile:function(){var e=this,t=document.getElementById("data_images_form");if(t){var o=new FormData(t),r={};for(var i of o.entries()){var a=i[0],n=i[1];0!==a.indexOf("settings[")&&(r[a]=n)}var l={};for(var i of o.entries()){a=i[0],n=i[1];if(0===a.indexOf("settings["))l[a.match(/settings\[(.+)\]/)[1]]=n}r.settings=l,r.action="save_profile",BX.showWait(),this.makeRequest("save_profile",r,function(t){if(BX.closeWait(),e.showAlert(t.message),!e.currentProfileId&&t.id){e.currentProfileId=t.id;var o=document.getElementById("profile_id");o&&(o.value=t.id)}e.loadProfiles(e.currentProfileId)},function(t){BX.closeWait(),e.showError(e.params.messageProfileSaveError),console.error("ImagesProfileManager: Save Profile Error",t)})}},makeRequest:function(e,t,o,r){(t=t||{}).action=e,t.sessid=this.sessid,BX.ajax({url:this.ajaxUrl,method:"POST",data:t,dataType:"json",onsuccess:function(e){e&&e.success?o&&o(e):r&&(console.error("ImagesProfileManager: Connect Error",e),r(e&&e.message?e.message:this.params.messageErrorServerConnect))},onfailure:function(e){r&&(console.error("ImagesProfileManager: Connect Error",e),r(this.params.messageErrorServerConnect))}})},renderFieldsSelection:function(){var e={FIELD:this.params.messageIblockField,PROPERTY:this.params.messageIblockProperty},t=this;Object.keys(e).forEach(function(e){var o=t.availableFields.filter(function(t){return t.TYPE===e});if(0!==o.length){var r=document.getElementById("images_field");r&&o.forEach(function(e){var t=document.createElement("option");t.value=e.CODE,t.textContent=e.NAME+" ["+e.CODE+"]",r.appendChild(t)})}})},toggleFieldsSelection:function(e){document.querySelectorAll(".fields-selection").forEach(function(t){t.style.display=e?"table-row":"none"})},fillForm:function(e){var t=document.getElementById("profile_id");t&&(t.value=e.ID);var o=document.getElementById("profile_name");o&&(o.value=e.NAME);var r=document.getElementById("iblock_type_select");r&&(r.value=e.IBLOCK_TYPE_ID||"");var i=document.getElementById("zip_file");i&&(i.value=e.ZIP_FILE||"")},fillImagesSettings:function(e){if(e)try{var t=JSON.parse(e);console.log("ImagesProfileManager: Profile settings",t),"string"==typeof t&&(t=JSON.parse(t));"object"!=typeof t||Array.isArray(t)||Object.keys(t).forEach(function(e){var o=document.querySelector('[name="settings['+e+']"]');o&&(o.value=t[e])})}catch(e){console.error("ImagesProfileManager: Settings Parser Error",e)}},toggleSettings:function(e){if(document.querySelectorAll(".profile-settings").forEach(function(t){t.style.display=e?"table-row":"none"}),!e){var t=document.getElementById("profile_select");t&&(t.value="")}},toggleButtons:function(e){["submit_btn","cancel_btn"].forEach(t=>{const o=document.getElementById(t);o&&(o.disabled=!e)})},resetForm:function(){var e=document.getElementById("data_images_form");e&&e.reset&&e.reset();var t=document.getElementById("profile_id");t&&(t.value="");var o=document.getElementById("iblock_select");o&&(o.innerHTML='<option value="">'+this.params.messageIblockTypeSelectFirst+"</option>",o.disabled=!0),this.toggleButtons(!1),this.toggleSettings(!1),this.toggleFieldsSelection(!1),this.currentProfileId=null,this.availableFields=[]},showAlert:function(e){BX.UI.Dialogs.MessageBox.alert(e,this.params.messageTitle)},showError:function(e){BX.UI.Dialogs.MessageBox.alert(e,this.params.messageError)}};