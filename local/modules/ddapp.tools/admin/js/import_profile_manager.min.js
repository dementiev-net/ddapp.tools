BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.ImportProfileManager=function(e){this.params=e||{},this.currentProfileId=null,this.availableFields=[],this.ajaxUrl=e&&e.ajaxUrl?e.ajaxUrl:window.location.href,this.sessid=BX.bitrix_sessid(),this.init()},BX.DDAPP.Tools.ImportProfileManager.prototype={init:function(){console.log("ImportProfileManager: Params",this.params),this.toggleButtons(!1),this.bindEvents(),this.loadProfiles(""),this.loadIblockTypes()},bindEvents:function(){var e=this,t=document.getElementById("profile_select");t?BX.bind(t,"change",function(){this.value?e.loadProfile(this.value):(e.resetForm(),e.toggleSettings(!1),e.toggleFieldsSelection(!1))}):console.warn("ImportProfileManager: Select profiles not found");var o=document.getElementById("create_profile_btn");o&&BX.bind(o,"click",function(){e.createNewProfile()});var r=document.getElementById("delete_profile_btn");r&&BX.bind(r,"click",function(){e.deleteProfile()});var l=document.getElementById("iblock_type_select");l&&BX.bind(l,"change",function(){e.loadIblocks(this.value)});var i=document.getElementById("iblock_select");i&&BX.bind(i,"change",function(){this.value?e.loadIblockFields(this.value):e.toggleFieldsSelection(!1)});var n=document.getElementById("select_all_fields");n&&BX.bind(n,"click",function(){e.selectAllFields(!0)});var a=document.getElementById("deselect_all_fields");a&&BX.bind(a,"click",function(){e.selectAllFields(!1)});var s=document.getElementById("data_import_form");s&&BX.bind(s,"submit",function(t){BX.PreventDefault(t),e.saveProfile()});var c=document.getElementById("cancel_btn");c&&BX.bind(c,"click",function(){e.toggleSettings(!1),e.resetForm()})},createNewProfile:function(){this.currentProfileId=null,this.resetForm(),this.toggleButtons(!0),this.toggleSettings(!0)},loadProfiles:function(e){var t=this;BX.showWait(),this.makeRequest("get_profiles",{},function(o){BX.closeWait();var r=document.getElementById("profile_select");r&&(r.innerHTML='<option value="">'+t.params.messageProfileSelect+"</option>",o.data&&o.data.length&&o.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,r.appendChild(t)}),e&&(r.value=e))},function(e){BX.closeWait(),t.showError(t.params.messageProfileLoadError),console.error("ImportProfileManager Load Profile Error:",e)})},loadProfile:function(e){var t=this;BX.showWait(),this.makeRequest("get_profile",{profile_id:e},function(o){var r=o.data;t.toggleButtons(!0),t.currentProfileId=e,t.fillForm(r),t.toggleSettings(!0),r.IBLOCK_TYPE_ID?t.loadIblocks(r.IBLOCK_TYPE_ID,function(){var e=document.getElementById("iblock_select");e&&(e.value=r.IBLOCK_ID),r.IBLOCK_ID?t.loadIblockFields(r.IBLOCK_ID,function(){t.fillImportSettings(r.SETTINGS),BX.closeWait()}):BX.closeWait()}):BX.closeWait()},function(e){BX.closeWait(),t.showError(t.params.messageProfileLoadError),console.error("ImportProfileManager Load Profile Error:",e)})},deleteProfile:function(){var e=this,t=document.getElementById("profile_select");if(!t)return;var o=t.value;if(!o)return void this.showAlert(e.params.messageProfileSelectError);BX.UI.Dialogs.MessageBox.create({message:e.params.messageBeforeDelete,title:e.params.messageTitle,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:function(t){e.doDeleteProfile(o),t.close()}}).show()},doDeleteProfile:function(e){var t=this;BX.showWait(),this.makeRequest("delete_profile",{profile_id:e},function(){BX.closeWait(),t.loadProfiles(""),t.toggleSettings(!1),t.resetForm(),t.showAlert(t.params.messageProfileDeleteOk)},function(e){BX.closeWait(),t.showError(t.params.messageProfileDeleteError),console.error("ImportProfileManager Delete Profile Error:",e)})},loadIblockTypes:function(){var e=this;this.makeRequest("get_iblock_types",{},function(t){var o=document.getElementById("iblock_type_select");o&&(o.innerHTML='<option value="">'+e.params.messageIblockTypeSelect+"</option>",t.data&&t.data.length&&t.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME||e.ID,o.appendChild(t)}))},function(t){e.showError(e.params.messageIblockSelectError),console.error("ImportProfileManager Load Profile Type Error:",t)})},loadIblocks:function(e,t){var o=this,r=document.getElementById("iblock_select");if(r)return e?void this.makeRequest("get_iblocks",{type_id:e},function(e){r.innerHTML='<option value="">'+o.params.messageIblockSelect+"</option>",e.data&&e.data.length&&e.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,r.appendChild(t)}),r.disabled=!1,t&&t()},function(e){console.error("ImportProfileManager Load Profile Error:",e)}):(r.innerHTML='<option value="">'+o.params.messageIblockTypeSelectFirst+"</option>",r.disabled=!0,void this.toggleFieldsSelection(!1))},loadIblockFields:function(e,t){var o=this;e?this.makeRequest("get_iblock_fields",{iblock_id:e},function(e){o.availableFields=e.data,o.renderFieldsSelection(),o.toggleFieldsSelection(!0),t&&t()},function(e){console.error("ImportProfileManager Load Iblock Fields Error:",e)}):this.toggleFieldsSelection(!1)},saveProfile:function(){var e=this,t=document.getElementById("data_import_form");if(t){var o=this.validateFieldsAndCells();if(o)this.showError(o);else{var r=new FormData(t),l={};for(var i of r.entries()){var n=i[0],a=i[1];0!==n.indexOf("settings[")&&(l[n]=a)}var s={},c=[],d={},u=document.getElementById("fields_container");if(u)u.querySelectorAll(".field-item").forEach(function(e){var t=e.querySelector('input[type="checkbox"]'),o=e.querySelector('input[type="text"]');t&&t.checked&&(c.push(t.value),o&&o.value&&(d[t.value]=o.value))});for(var i of r.entries()){n=i[0],a=i[1];if(0===n.indexOf("settings[")&&"settings[import_fields][]"!==n){var f=n.match(/settings\[(.+)\]/)[1];s[f]=a}}c.length>0&&(s.import_fields=c,s.import_cells=d),t.querySelectorAll('input[type="checkbox"][name^="settings["]').forEach(function(e){if("settings[import_fields][]"!==e.name){var t=e.name.match(/settings\[(.+)\]/)[1];void 0===s[t]&&(s[t]=e.checked?"Y":"N")}}),l.settings=s,l.action="save_profile",BX.showWait(),this.makeRequest("save_profile",l,function(t){if(BX.closeWait(),e.showAlert(t.message),!e.currentProfileId&&t.id){e.currentProfileId=t.id;var o=document.getElementById("profile_id");o&&(o.value=t.id)}e.loadProfiles(e.currentProfileId)},function(t){BX.closeWait(),e.showError(e.params.messageProfileSaveError),console.error("ImportProfileManager Save Profile Error:",t)})}}},makeRequest:function(e,t,o,r){(t=t||{}).action=e,t.sessid=this.sessid,BX.ajax({url:this.ajaxUrl,method:"POST",data:t,dataType:"json",onsuccess:function(e){e&&e.success?o&&o(e):r&&(console.error("ImportProfileManager Connect Error",e),r(e&&e.message?e.message:this.params.messageErrorServerConnect))},onfailure:function(e){r&&(console.error("ImportProfileManager Connect Error:",e),r(this.params.messageErrorServerConnect))}})},renderFieldsSelection:function(){var e=document.getElementById("fields_container");if(e){e.innerHTML="";var t={FIELD:this.params.messageIblockField,PROPERTY:this.params.messageIblockProperty},o=this;Object.keys(t).forEach(function(r){var l=o.availableFields.filter(function(e){return e.TYPE===r});if(0!==l.length){var i=document.createElement("div");i.className="field-group";var n=document.createElement("h3");n.textContent=t[r],i.appendChild(n);var a=document.createElement("div");a.className="sortable-container",a.setAttribute("data-group",r),l.forEach(function(e){var t=document.createElement("div");t.className="field-item",t.setAttribute("data-field-code",e.CODE);var o=document.createElement("input");o.type="checkbox",o.name="settings[import_fields][]",o.value=e.CODE,o.id="field_"+e.CODE,o.className="field-checkbox";var r=document.createElement("input");r.type="text",r.value="",r.id="cell_"+e.CODE,r.className="field-input",r.placeholder="A1";var l=document.createElement("label");l.setAttribute("for","field_"+e.CODE),l.textContent=e.NAME+" ["+e.CODE+"]",l.className="field-label",l.style.flex="1";var i=document.createElement("label");i.setAttribute("for","cell_"+e.CODE),i.textContent="ячейка",i.className="field-label",t.appendChild(o),t.appendChild(l),t.appendChild(r),t.appendChild(i),a.appendChild(t)}),i.appendChild(a),e.appendChild(i)}})}},toggleFieldsSelection:function(e){document.querySelectorAll(".fields-selection").forEach(function(t){t.style.display=e?"table-row":"none"})},selectAllFields:function(e){document.querySelectorAll('input[name="settings[import_fields][]"]').forEach(function(t){t.checked=e})},fillForm:function(e){var t=document.getElementById("profile_id");t&&(t.value=e.ID);var o=document.getElementById("profile_name");o&&(o.value=e.NAME);var r=document.getElementById("iblock_type_select");r&&(r.value=e.IBLOCK_TYPE_ID||"")},fillImportSettings:function(e){if(e)try{var t=JSON.parse(e);console.log("ImportProfileManager: Profile settings:",t),"string"==typeof t&&(t=JSON.parse(t));var o=this;"object"!=typeof t||Array.isArray(t)||Object.keys(t).forEach(function(e){if("import_fields"===e&&Array.isArray(t[e]))o.restoreFields(t[e],t.import_cells);else if("import_cells"===e);else{var r=document.querySelector('[name="settings['+e+']"]');r&&("checkbox"===r.type?r.checked="Y"===t[e]:r.value=t[e])}})}catch(e){console.error("ImportProfileManager Settings Parser Error:",e)}},toggleSettings:function(e){if(document.querySelectorAll(".profile-settings").forEach(function(t){t.style.display=e?"table-row":"none"}),!e){var t=document.getElementById("profile_select");t&&(t.value="")}},toggleButtons:function(e){["submit_btn","cancel_btn"].forEach(t=>{const o=document.getElementById(t);o&&(o.disabled=!e)})},resetForm:function(){var e=document.getElementById("data_import_form");e&&e.reset&&e.reset();var t=document.getElementById("profile_id");t&&(t.value="");var o=document.getElementById("iblock_select");o&&(o.innerHTML='<option value="">'+this.params.messageIblockTypeSelectFirst+"</option>",o.disabled=!0),this.toggleButtons(!1),this.toggleSettings(!1),this.toggleFieldsSelection(!1),this.currentProfileId=null,this.availableFields=[]},restoreFields:function(e,t){if(e&&Array.isArray(e)){e.forEach(function(e){var o=document.querySelector('input[value="'+e+'"]');if(o&&(o.checked=!0),t&&t[e]){var r=document.querySelector('input[id="cell_'+e+'"]');r&&(r.value=t[e])}})}},validateFieldsAndCells:function(){var e=document.getElementById("fields_container");if(!e)return null;var t=e.querySelectorAll(".field-item"),o=[];return t.forEach(function(e){var t=e.querySelector('input[type="text"]');t&&(t.style.border="")}),t.forEach(function(e){var t=e.querySelector('input[type="checkbox"]'),r=e.querySelector('input[type="text"]');if(t&&t.checked&&(!r||!r.value.trim())){var l=e.querySelector(".field-label"),i=l?l.textContent:t.value;o.push(i),r&&(r.style.border="1px solid red")}}),o.length>0?this.params.messageIblockFieldValidationError+o.join(", "):null},showAlert:function(e){BX.UI.Dialogs.MessageBox.alert(e,this.params.messageTitle)},showError:function(e){BX.UI.Dialogs.MessageBox.alert(e,this.params.messageError)}};