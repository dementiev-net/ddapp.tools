BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.ExportProfileManager=function(e){this.params=e||{},this.currentProfileId=null,this.availableFields=[],this.ajaxUrl=e&&e.ajaxUrl?e.ajaxUrl:window.location.href,this.sessid=BX.bitrix_sessid(),this.init()},BX.DDAPP.Tools.ExportProfileManager.prototype={init:function(){console.log("ExportProfileManager: Params",this.params),this.toggleButtons(!1),this.bindEvents(),this.loadProfiles(""),this.loadIblockTypes()},bindEvents:function(){var e=this,t=document.getElementById("profile_select");t?BX.bind(t,"change",function(){this.value?e.loadProfile(this.value):(e.resetForm(),e.toggleSettings(!1),e.toggleFieldsSelection(!1),e.hideExportSettings())}):console.warn("ExportProfileManager: Select profiles not found");var o=document.getElementById("create_profile_btn");o&&BX.bind(o,"click",function(){e.createNewProfile()});var r=document.getElementById("delete_profile_btn");r&&BX.bind(r,"click",function(){e.deleteProfile()});var n=document.getElementById("iblock_type_select");n&&BX.bind(n,"change",function(){e.loadIblocks(this.value)});var i=document.getElementById("iblock_select");i&&BX.bind(i,"change",function(){this.value?e.loadIblockFields(this.value):e.toggleFieldsSelection(!1)});var l=document.getElementById("export_type_select");l&&BX.bind(l,"change",function(){e.showExportSettings(this.value)});var a=document.getElementById("select_all_fields");a&&BX.bind(a,"click",function(){e.selectAllFields(!0)});var s=document.getElementById("deselect_all_fields");s&&BX.bind(s,"click",function(){e.selectAllFields(!1)});var c=document.getElementById("data_export_form");c&&BX.bind(c,"submit",function(t){BX.PreventDefault(t),e.saveProfile()});var d=document.getElementById("cancel_btn");d&&BX.bind(d,"click",function(){e.toggleSettings(!1),e.resetForm()})},createNewProfile:function(){this.currentProfileId=null,this.resetForm(),this.toggleButtons(!0),this.toggleSettings(!0)},loadProfiles:function(e){var t=this;BX.showWait(),this.makeRequest("get_profiles",{},function(o){BX.closeWait();var r=document.getElementById("profile_select");r&&(r.innerHTML='<option value="">'+t.params.messageProfileSelect+"</option>",o.data&&o.data.length&&o.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,r.appendChild(t)}),e&&(r.value=e))},function(e){BX.closeWait(),t.showError(t.params.messageProfileLoadError),console.error("ExportProfileManager Load Profile Error:",e)})},loadProfile:function(e){var t=this;BX.showWait(),this.makeRequest("get_profile",{profile_id:e},function(o){var r=o.data;t.toggleButtons(!0),t.currentProfileId=e,t.fillForm(r),t.toggleSettings(!0),r.IBLOCK_TYPE_ID?t.loadIblocks(r.IBLOCK_TYPE_ID,function(){var e=document.getElementById("iblock_select");e&&(e.value=r.IBLOCK_ID),r.IBLOCK_ID?t.loadIblockFields(r.IBLOCK_ID,function(){r.EXPORT_TYPE&&(t.showExportSettings(r.EXPORT_TYPE),t.fillExportSettings(r.SETTINGS)),BX.closeWait()}):BX.closeWait()}):BX.closeWait()},function(e){BX.closeWait(),t.showError(t.params.messageProfileLoadError),console.error("ExportProfileManager Load Profile Error:",e)})},deleteProfile:function(){var e=this,t=document.getElementById("profile_select");if(!t)return;var o=t.value;if(!o)return void this.showAlert(e.params.messageProfileSelectError);BX.UI.Dialogs.MessageBox.create({message:e.params.messageBeforeDelete,title:e.params.messageTitle,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:function(t){e.doDeleteProfile(o),t.close()}}).show()},doDeleteProfile:function(e){var t=this;BX.showWait(),this.makeRequest("delete_profile",{profile_id:e},function(){BX.closeWait(),t.loadProfiles(""),t.toggleSettings(!1),t.resetForm(),t.showAlert(t.params.messageProfileDeleteOk)},function(e){BX.closeWait(),t.showError(t.params.messageProfileDeleteError),console.error("ExportProfileManager Delete Profile Error:",e)})},loadIblockTypes:function(){var e=this;this.makeRequest("get_iblock_types",{},function(t){var o=document.getElementById("iblock_type_select");o&&(o.innerHTML='<option value="">'+e.params.messageIblockTypeSelect+"</option>",t.data&&t.data.length&&t.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME||e.ID,o.appendChild(t)}))},function(t){e.showError(e.params.messageIblockSelectError),console.error("ExportProfileManager Load Profile Type Error:",t)})},loadIblocks:function(e,t){var o=this,r=document.getElementById("iblock_select");if(r)return e?void this.makeRequest("get_iblocks",{type_id:e},function(e){r.innerHTML='<option value="">'+o.params.messageIblockSelect+"</option>",e.data&&e.data.length&&e.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,r.appendChild(t)}),r.disabled=!1,t&&t()},function(e){console.error("ExportProfileManager Load Profile Error:",e)}):(r.innerHTML='<option value="">'+o.params.messageIblockTypeSelectFirst+"</option>",r.disabled=!0,void this.toggleFieldsSelection(!1))},loadIblockFields:function(e,t){var o=this;e?this.makeRequest("get_iblock_fields",{iblock_id:e},function(e){o.availableFields=e.data,o.renderFieldsSelection(),o.toggleFieldsSelection(!0),t&&t()},function(e){console.error("ExportProfileManager Load Iblock Fields Error:",e)}):this.toggleFieldsSelection(!1)},saveProfile:function(){var e=this,t=document.getElementById("data_export_form");if(t){var o=new FormData(t),r={};for(var n of o.entries()){var i=n[0],l=n[1];0!==i.indexOf("settings[")&&(r[i]=l)}var a={},s=[],c=document.getElementById("fields_container");if(c)c.querySelectorAll(".field-item").forEach(function(e){var t=e.querySelector('input[type="checkbox"]');t&&t.checked&&s.push(t.value)});for(var n of o.entries()){i=n[0],l=n[1];if(0===i.indexOf("settings[")&&"settings[export_fields][]"!==i){var d=i.match(/settings\[(.+)\]/)[1];a[d]=l}}s.length>0&&(a.export_fields=s),t.querySelectorAll('input[type="checkbox"][name^="settings["]').forEach(function(e){if("settings[export_fields][]"!==e.name){var t=e.name.match(/settings\[(.+)\]/)[1];void 0===a[t]&&(a[t]=e.checked?"Y":"N")}}),r.settings=a,r.action="save_profile",BX.showWait(),this.makeRequest("save_profile",r,function(t){if(BX.closeWait(),e.showAlert(t.message),!e.currentProfileId&&t.id){e.currentProfileId=t.id;var o=document.getElementById("profile_id");o&&(o.value=t.id)}e.loadProfiles(e.currentProfileId)},function(t){BX.closeWait(),e.showError(e.params.messageProfileSaveError),console.error("ExportProfileManager Save Profile Error:",t)})}},makeRequest:function(e,t,o,r){(t=t||{}).action=e,t.sessid=this.sessid,BX.ajax({url:this.ajaxUrl,method:"POST",data:t,dataType:"json",onsuccess:function(e){e&&e.success?o&&o(e):r&&(console.error("ExportProfileManager Connect Error",e),r(e&&e.message?e.message:this.params.messageErrorServerConnect))},onfailure:function(e){r&&(console.error("ExportProfileManager Connect Error:",e),r(this.params.messageErrorServerConnect))}})},renderFieldsSelection:function(){var e=document.getElementById("fields_container");if(e){e.innerHTML="";var t={FIELD:this.params.messageIblockField,PROPERTY:this.params.messageIblockProperty},o=this;Object.keys(t).forEach(function(r){var n=o.availableFields.filter(function(e){return e.TYPE===r});if(0!==n.length){var i=document.createElement("div");i.className="field-group";var l=document.createElement("h3");l.textContent=t[r],i.appendChild(l);var a=document.createElement("div");a.className="sortable-container",a.setAttribute("data-group",r),n.forEach(function(e){var t=document.createElement("div");t.className="field-item",t.setAttribute("draggable","true"),t.setAttribute("data-field-code",e.CODE);var o=document.createElement("span");o.className="drag-handle",o.innerHTML="⋮⋮";var r=document.createElement("input");r.type="checkbox",r.name="settings[export_fields][]",r.value=e.CODE,r.id="field_"+e.CODE,r.className="field-checkbox";var n=document.createElement("label");n.setAttribute("for","field_"+e.CODE),n.textContent=e.NAME+" ["+e.CODE+"]",n.className="field-label",t.appendChild(o),t.appendChild(r),t.appendChild(n),a.appendChild(t)}),i.appendChild(a),e.appendChild(i)}}),this.initDragAndDrop()}},initDragAndDrop:function(){var e=document.querySelectorAll(".sortable-container"),t=this;e.forEach(function(e){t.makeSortable(e)})},makeSortable:function(e){var t=this,o=null,r=null;e.addEventListener("dragstart",function(e){var t=e.target.closest(".field-item");t&&(o=t,t.classList.add("dragging"),(r=document.createElement("div")).className="field-item",r.style.height=t.offsetHeight+"px",r.style.background="#e3f2fd",r.style.border="1px dashed #2196f3",r.style.opacity="0.5",r.innerHTML='<span style="color: #2196f3; text-align: center; display: block;"></span>',e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",t.outerHTML)))}),e.addEventListener("dragend",function(e){o&&(o.classList.remove("dragging"),o=null),r&&r.parentNode&&(r.parentNode.removeChild(r),r=null)}),e.addEventListener("dragover",function(n){if(n.preventDefault(),n.dataTransfer&&(n.dataTransfer.dropEffect="move"),o&&r){var i=t.getDragAfterElement(e,n.clientY);null==i?e.appendChild(r):e.insertBefore(r,i)}}),e.addEventListener("drop",function(e){e.preventDefault(),o&&r&&(r.parentNode.replaceChild(o,r),t.updateFieldsOrder())})},getDragAfterElement:function(e,t){return Array.from(e.querySelectorAll(".field-item:not(.dragging)")).reduce(function(e,o){var r=o.getBoundingClientRect(),n=t-r.top-r.height/2;return n<0&&n>e.offset?{offset:n,element:o}:e},{offset:Number.NEGATIVE_INFINITY}).element},updateFieldsOrder:function(){var e=document.getElementById("fields_container");if(e){var t=e.querySelectorAll(".field-item"),o=[];t.forEach(function(e,t){var r=e.getAttribute("data-field-code"),n=e.querySelector('input[type="checkbox"]');n&&r&&(n.setAttribute("data-sort-order",t),o.push({code:r,order:t,selected:n.checked}))}),this.fieldsOrder=o}},toggleFieldsSelection:function(e){document.querySelectorAll(".fields-selection").forEach(function(t){t.style.display=e?"table-row":"none"})},selectAllFields:function(e){document.querySelectorAll('input[name="settings[export_fields][]"]').forEach(function(t){t.checked=e})},showExportSettings:function(e){this.hideExportSettings();var t={xls:".excel-settings",csv:".csv-settings"}[e];t&&document.querySelectorAll(t).forEach(function(e){e.style.display="table-row"})},hideExportSettings:function(){[".excel-settings",".csv-settings"].forEach(function(e){document.querySelectorAll(e).forEach(function(e){e.style.display="none"})})},fillForm:function(e){var t=document.getElementById("profile_id");t&&(t.value=e.ID);var o=document.getElementById("profile_name");o&&(o.value=e.NAME);var r=document.getElementById("iblock_type_select");r&&(r.value=e.IBLOCK_TYPE_ID||"");var n=document.getElementById("export_type_select");n&&(n.value=e.EXPORT_TYPE||"")},fillExportSettings:function(e){if(e)try{var t=JSON.parse(e);console.log("ExportProfileManager: Profile settings:",t),"string"==typeof t&&(t=JSON.parse(t));var o=this;"object"!=typeof t||Array.isArray(t)||Object.keys(t).forEach(function(e){if("export_fields"===e&&Array.isArray(t[e]))o.restoreFieldsOrder(t[e]);else{var r=document.querySelector('[name="settings['+e+']"]');r&&("checkbox"===r.type?r.checked="Y"===t[e]:r.value=t[e])}})}catch(e){console.error("ExportProfileManager Settings Parser Error:",e)}},toggleSettings:function(e){if(document.querySelectorAll(".profile-settings").forEach(function(t){t.style.display=e?"table-row":"none"}),!e){var t=document.getElementById("profile_select");t&&(t.value="")}},toggleButtons:function(e){["submit_btn","cancel_btn"].forEach(t=>{const o=document.getElementById(t);o&&(o.disabled=!e)})},resetForm:function(){var e=document.getElementById("data_export_form");e&&e.reset&&e.reset();var t=document.getElementById("profile_id");t&&(t.value="");var o=document.getElementById("iblock_select");o&&(o.innerHTML='<option value="">'+this.params.messageIblockTypeSelectFirst+"</option>",o.disabled=!0),this.toggleButtons(!1),this.toggleSettings(!1),this.toggleFieldsSelection(!1),this.hideExportSettings(),this.currentProfileId=null,this.availableFields=[]},restoreFieldsOrder:function(e){if(e&&Array.isArray(e)){e.forEach(function(e){var t=document.querySelector('input[value="'+e+'"]');t&&(t.checked=!0)}),document.querySelectorAll(".sortable-container").forEach(function(t){var o=Array.from(t.querySelectorAll(".field-item")),r=[];e.forEach(function(e){var t=o.find(function(t){return t.getAttribute("data-field-code")===e});t&&r.push(t)}),o.forEach(function(e){-1===r.indexOf(e)&&r.push(e)}),r.forEach(function(e){t.appendChild(e)})})}},showAlert:function(e){BX.UI.Dialogs.MessageBox.alert(e,this.params.messageTitle)},showError:function(e){BX.UI.Dialogs.MessageBox.alert(e,this.params.messageError)}};