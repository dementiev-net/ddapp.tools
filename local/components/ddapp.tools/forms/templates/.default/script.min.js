BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.FormManager=function(e){this.params=e||{},this.form=null,this.modal=null,this.messagesBlock=null,this.submitButton=null,this.isSubmitting=!1,this.recaptchaLoaded=!1,this.sessid=BX.bitrix_sessid(),this.fileConfig=this.params.fileConfig||{},this.selectedFiles=new Map,this.dragCounter=0,this.isMobile=this.detectMobile(),this.analytics=new BX.DDAPP.Tools.Analytics,this.init()},BX.DDAPP.Tools.FormManager.prototype={init:function(){this.form=BX(this.params.formId),this.modal=BX(this.params.modalId),this.messagesBlock=BX(this.params.messagesId),this.submitButton=this.form.querySelector('button[type="submit"]'),"Y"===this.params.useGoogleRecaptcha&&this.loadRecaptcha(),this.bindEvents(),this.initFileHandling(),this.initMobileOptimizations(),this.trackAnalytics("form_loaded",{form_id:this.params.formId})},detectMobile:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768},bindEvents:function(){if(BX.bind(this.form,"submit",BX.proxy(this.onSubmit,this)),this.modal){var e=this;this.modal.addEventListener("hidden.bs.modal",function(){e.onModalHidden(),e.trackAnalytics("form_closed")}),this.modal.addEventListener("shown.bs.modal",function(){e.trackAnalytics("form_opened")})}for(var t=this.form.querySelectorAll("input, textarea, select"),i=0;i<t.length;i++)BX.bind(t[i],"focus",BX.proxy(function(e){this.trackAnalytics("field_focused",{field_type:e.target.type,field_name:e.target.name})},this))},initFileHandling:function(){for(var e=this.form.querySelectorAll('input[type="file"]'),t=0;t<e.length;t++)this.setupFileInput(e[t])},setupFileInput:function(e){var t=this,i=this.createFileWrapper(e);e.parentNode.insertBefore(i,e),i.appendChild(e),e.style.display="none",this.initDragAndDrop(i,e),BX.bind(e,"change",function(e){t.handleFileSelection(e.target,i)});var s=i.querySelector(".file-select-btn");BX.bind(s,"click",function(){e.click()})},createFileWrapper:function(e){var t=e.hasAttribute("multiple"),i=(e.closest(".form-group").querySelector("label").textContent.trim(),document.createElement("div"));return i.className="file-upload-wrapper",i.innerHTML='<div class="file-drop-zone"><div class="drop-content"><div class="drop-icon">üìÅ</div><div class="drop-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª'+(t?"—ã":"")+' —Å—é–¥–∞</div><div class="drop-hint">–∏–ª–∏</div><button type="button" class="btn btn-outline-primary file-select-btn">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'+(t?"—ã":"")+'</button></div></div><div class="file-info"><small><strong>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:</strong><br>‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: '+Math.round(this.fileConfig.max_size/1024/1024*10)/10+" MB<br>‚Ä¢ –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã: "+(this.fileConfig.allowed_extensions||[]).join(", ").toUpperCase()+'</small></div><div class="selected-files-preview"></div>',i},initDragAndDrop:function(e,t){var i=this,s=e.querySelector(".file-drop-zone");["dragenter","dragover","dragleave","drop"].forEach(function(e){BX.bind(s,e,function(e){e.preventDefault(),e.stopPropagation()})}),BX.bind(s,"dragenter",function(e){i.dragCounter++,BX.addClass(s,"dragover"),i.trackAnalytics("file_drag_enter")}),BX.bind(s,"dragleave",function(e){i.dragCounter--,0===i.dragCounter&&BX.removeClass(s,"dragover")}),BX.bind(s,"drop",function(a){i.dragCounter=0,BX.removeClass(s,"dragover");var r=a.dataTransfer.files;r.length>0&&(i.handleDroppedFiles(r,t,e),i.trackAnalytics("files_dropped",{count:r.length}))})},handleDroppedFiles:function(e,t,i){var s=new DataTransfer;if(t.hasAttribute("multiple")&&t.files)for(var a=0;a<t.files.length;a++)s.items.add(t.files[a]);for(a=0;a<e.length&&(t.hasAttribute("multiple")||!(a>0));a++)s.items.add(e[a]);t.files=s.files,this.handleFileSelection(t,i)},handleFileSelection:function(e,t){var i=e.files,s=e.name.replace("property_","").replace("[]","");if(this.clearFileValidationError(t),0===i.length)return this.updateFilePreview(t,[]),void this.selectedFiles.delete(s);for(var a=[],r=[],n=0;n<i.length;n++){var o=i[n],l=this.validateSingleFile(o);0===l.length?a.push(o):r=r.concat(l)}r.length>0?(this.showFileValidationError(t,r),e.value="",this.trackAnalytics("file_validation_failed",{errors_count:r.length,files_count:i.length})):(this.selectedFiles.set(s,a),this.updateFilePreview(t,a),this.trackAnalytics("files_selected",{count:a.length,total_size:Array.from(a).reduce((e,t)=>e+t.size,0)}))},validateSingleFile:function(e){var t=[],i=this.fileConfig.max_size||10485760,s=this.fileConfig.allowed_extensions||[],a=this.fileConfig.forbidden_extensions||[],r=e.name.toLowerCase().split(".").pop();if(e.size>i){var n=Math.round(i/1024/1024*10)/10;t.push('–§–∞–π–ª "'+e.name+'" –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä ('+n+" MB)")}return-1!==a.indexOf(r)?(t.push('–¢–∏–ø —Ñ–∞–π–ª–∞ "'+r+'" –∑–∞–ø—Ä–µ—â–µ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏'),t):(s.length>0&&-1===s.indexOf(r)&&t.push('–¢–∏–ø —Ñ–∞–π–ª–∞ "'+r+'" –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω'),this.isFileNameSuspicious(e.name)&&t.push('–ò–º—è —Ñ–∞–π–ª–∞ "'+e.name+'" —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã'),t)},updateFilePreview:function(e,t){var i=e.querySelector(".selected-files-preview");if(i.innerHTML="",0!==t.length){var s=document.createElement("div");s.className="selected-files";for(var a=0;a<t.length;a++){var r=t[a],n=this.createFilePreviewItem(r,a,e);s.appendChild(n)}i.appendChild(s)}},createFilePreviewItem:function(e,t,i){var s=this,a=document.createElement("div");a.className="file-item";var r=this.formatFileSize(e.size),n=this.isImageFile(e);a.innerHTML='<div class="file-info-block">'+(n?'<div class="file-thumbnail"></div>':'<div class="file-icon">üìÑ</div>')+'<div class="file-details"><div class="file-name">'+e.name+'</div><div class="file-size">'+r+'</div></div></div><button type="button" class="file-remove" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª">√ó</button>',n&&this.createImageThumbnail(e,a.querySelector(".file-thumbnail"));var o=a.querySelector(".file-remove");return BX.bind(o,"click",function(){s.removeFileFromSelection(i,t),s.trackAnalytics("file_removed",{file_name:e.name})}),a},createImageThumbnail:function(e,t){if(e.type.startsWith("image/")){var i=new FileReader;i.onload=function(e){var i=document.createElement("img");i.src=e.target.result,i.className="thumbnail-image",i.style.maxWidth="50px",i.style.maxHeight="50px",i.style.objectFit="cover",t.appendChild(i)},i.readAsDataURL(e)}},removeFileFromSelection:function(e,t){var i=e.querySelector('input[type="file"]'),s=i.name.replace("property_","").replace("[]",""),a=Array.from(this.selectedFiles.get(s)||[]);if(a.splice(t,1),0===a.length)this.selectedFiles.delete(s),i.value="";else{this.selectedFiles.set(s,a);var r=new DataTransfer;a.forEach(function(e){r.items.add(e)}),i.files=r.files}this.updateFilePreview(e,a)},isImageFile:function(e){return e.type.startsWith("image/")},formatFileSize:function(e){if(0===e)return"0 B";var t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["B","KB","MB","GB"][t]},initMobileOptimizations:function(){if(this.isMobile){BX.addClass(this.form,"mobile-optimized");for(var e=this.form.querySelectorAll("input, button, select, textarea"),t=0;t<e.length;t++)BX.addClass(e[t],"mobile-input");this.enableErrorScrolling(),this.handleVirtualKeyboard()}},enableErrorScrolling:function(){var e=this;this.originalShowMessage=this.showMessage,this.showMessage=function(t,i){e.originalShowMessage.call(e,t,i),"error"===i&&e.messagesBlock&&setTimeout(function(){e.messagesBlock.scrollIntoView({behavior:"smooth",block:"center"})},100)}},handleVirtualKeyboard:function(){var e=window.innerHeight;window.addEventListener("resize",function(){var t=window.innerHeight,i=e-t;document.body.style.height=i>150?t+"px":""})},isFileNameSuspicious:function(e){return/[<>:"|?*]/.test(e)||-1!==e.substring(0,e.lastIndexOf(".")).indexOf(".")},showFileValidationError:function(e,t){var i=document.createElement("div");i.className="file-validation-error text-danger mt-2",i.innerHTML=t.join("<br>"),e.appendChild(i),BX.addClass(e,"has-error"),BX.addClass(e,"shake"),setTimeout(function(){BX.removeClass(e,"shake")},500)},clearFileValidationError:function(e){var t=e.querySelector(".file-validation-error");t&&t.remove(),BX.removeClass(e,"has-error")},loadRecaptcha:function(){if(!this.recaptchaLoaded&&this.params.recaptchaPublicKey){var e=document.createElement("script");e.src="https://www.google.com/recaptcha/api.js?render="+this.params.recaptchaPublicKey,e.onload=BX.proxy(function(){this.recaptchaLoaded=!0},this),document.head.appendChild(e)}},onSubmit:function(e){return e.preventDefault(),!this.isSubmitting&&(this.hideMessage(),this.trackAnalytics("form_submit_attempt"),this.validateForm()?this.validateAllFiles()?void("Y"===this.params.useGoogleRecaptcha?this.submitWithRecaptcha():this.submitForm()):(this.showMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–∞—Ö","error"),this.trackAnalytics("file_validation_failed_on_submit"),!1):(this.trackAnalytics("form_validation_failed"),!1))},validateForm:function(){var e=this.form.querySelectorAll("[required]"),t=!0;this.clearValidationErrors();for(var i=0;i<e.length;i++){var s=e[i];this.getFieldValue(s)||(this.addValidationError(s),t=!1)}return t},validateAllFiles:function(){for(var e=this.form.querySelectorAll('input[type="file"]'),t=!0,i=0;i<e.length;i++)if(e[i].files&&e[i].files.length>0)for(var s=0;s<e[i].files.length;s++){if(this.validateSingleFile(e[i].files[s]).length>0){t=!1;break}}return t},getFieldValue:function(e){if("checkbox"===e.type||"radio"===e.type){var t=e.name;return this.form.querySelectorAll('input[name="'+t+'"]:checked').length>0}return"file"===e.type?e.files&&e.files.length>0:e.value.trim()},addValidationError:function(e){BX.addClass(e,"is-invalid");var t=e.closest(".form-group");t&&BX.addClass(t,"has-error")},clearValidationErrors:function(){for(var e=this.form.querySelectorAll(".is-invalid"),t=0;t<e.length;t++)BX.removeClass(e[t],"is-invalid");for(var i=this.form.querySelectorAll(".has-error"),s=0;s<i.length;s++)BX.removeClass(i[s],"has-error");for(var a=this.form.querySelectorAll(".file-validation-error"),r=0;r<a.length;r++)a[r].remove()},submitWithRecaptcha:function(){var e=this;this.recaptchaLoaded&&"undefined"!=typeof grecaptcha?grecaptcha.ready(function(){grecaptcha.execute(e.params.recaptchaPublicKey,{action:"submit"}).then(function(t){var i=document.createElement("input");i.type="hidden",i.name="g-recaptcha-response",i.value=t,e.form.appendChild(i),e.submitForm()})}):this.showMessage("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ reCAPTCHA","error")},submitForm:function(){this.isSubmitting=!0,this.setSubmitButtonState(!0),this.trackAnalytics("form_submit_started");var e=new FormData(this.form);e.append("sessid",this.sessid);var t=this;BX.ajax({method:"POST",dataType:"json",url:window.location.href,data:e,processData:!1,start:function(){t.trackAnalytics("ajax_request_started")},onsuccess:function(e){t.onSuccess(e)},onfailure:function(){t.onFailure()}})},onSuccess:function(e){this.isSubmitting=!1,this.setSubmitButtonState(!1),e.success?(this.showMessage(e.message,"success"),this.resetForm(),this.trackAnalytics("form_submit_success",{element_id:e.element_id}),setTimeout(BX.proxy(this.hideModal,this),2e3)):(this.showMessage(e.message,"error"),this.trackAnalytics("form_submit_error",{error_message:e.message}))},onFailure:function(){this.isSubmitting=!1,this.setSubmitButtonState(!1),this.showMessage("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã","error"),this.trackAnalytics("form_submit_failure")},setSubmitButtonState:function(e){this.submitButton&&(this.submitButton.disabled=e,this.submitButton.innerHTML=e?'<span class="spinner-border spinner-border-sm me-2"></span>–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...':"–û—Ç–ø—Ä–∞–≤–∏—Ç—å")},resetForm:function(){this.form.reset(),this.clearValidationErrors(),this.selectedFiles.clear();for(var e=this.form.querySelectorAll(".selected-files-preview"),t=0;t<e.length;t++)e[t].innerHTML=""},hideModal:function(){if(this.modal){var e=bootstrap.Modal.getInstance(this.modal);if(e)e.hide();else new bootstrap.Modal(this.modal).hide()}},onModalHidden:function(){this.resetForm(),this.hideMessage()},showMessage:function(e,t){this.messagesBlock&&(this.messagesBlock.innerHTML=e,this.messagesBlock.className="alert alert-"+("success"===t?"success":"danger"),this.messagesBlock.style.display="block","success"===t&&this.isMobile&&setTimeout(BX.proxy(this.hideMessage,this),3e3))},hideMessage:function(){this.messagesBlock&&(this.messagesBlock.style.display="none",this.messagesBlock.innerHTML="")},trackAnalytics:function(e,t){this.analytics.track(e,Object.assign({form_id:this.params.formId,timestamp:Date.now()},t||{}))},addCustomValidator:function(e){},getFormData:function(){return new FormData(this.form)},destroy:function(){this.selectedFiles.clear()}},BX.DDAPP.Tools.Analytics=function(){this.queue=[],this.init()},BX.DDAPP.Tools.Analytics.prototype={init:function(){"undefined"!=typeof gtag&&this.processQueue(),window.ddappAnalytics&&(this.queue=this.queue.concat(window.ddappAnalytics),this.processQueue())},track:function(e,t){var i={event_name:e,parameters:t||{}};this.queue.push(i),this.processQueue()},processQueue:function(){if("undefined"!=typeof gtag)for(;this.queue.length>0;){var e=this.queue.shift();if(gtag("event",e.event_name,e.parameters),"undefined"!=typeof ym&&window.yaCounter){var t=this.mapEventToYandexGoal(e.event_name);t&&ym(window.yaCounter,"reachGoal",t,e.parameters)}}},mapEventToYandexGoal:function(e){return{form_submit_success:"form_submit",form_opened:"form_view",files_selected:"file_upload"}[e]||null}};