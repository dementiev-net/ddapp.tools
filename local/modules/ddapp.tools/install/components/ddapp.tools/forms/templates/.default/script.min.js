BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.FormManager=function(t){this.params=t||{},this.form=null,this.modal=null,this.messagesBlock=null,this.submitButton=null,this.isSubmitting=!1,this.recaptchaLoaded=!1,this.sessid=BX.bitrix_sessid(),this.init()},BX.DDAPP.Tools.FormManager.prototype={init:function(){this.form=BX(this.params.formId),this.modal=BX(this.params.modalId),this.messagesBlock=BX(this.params.messagesId),this.submitButton=this.form.querySelector('button[type="submit"]'),"Y"===this.params.useGoogleRecaptcha&&this.loadRecaptcha(),this.bindEvents()},bindEvents:function(){if(BX.bind(this.form,"submit",BX.proxy(this.onSubmit,this)),this.modal){var t=this;this.modal.addEventListener("hidden.bs.modal",function(){t.onModalHidden()})}},loadRecaptcha:function(){if(!this.recaptchaLoaded&&this.params.recaptchaPublicKey){var t=document.createElement("script");t.src="https://www.google.com/recaptcha/api.js?render="+this.params.recaptchaPublicKey,t.onload=BX.proxy(function(){this.recaptchaLoaded=!0},this),document.head.appendChild(t)}},onSubmit:function(t){return t.preventDefault(),!this.isSubmitting&&(this.hideMessage(),!!this.validateForm()&&void("Y"===this.params.useGoogleRecaptcha?this.submitWithRecaptcha():this.submitForm()))},validateForm:function(){var t=this.form.querySelectorAll("[required]"),e=!0;this.clearValidationErrors();for(var s=0;s<t.length;s++){var i=t[s];this.getFieldValue(i)||(this.addValidationError(i),e=!1)}return e},getFieldValue:function(t){if("checkbox"===t.type||"radio"===t.type){var e=t.name;return this.form.querySelectorAll('input[name="'+e+'"]:checked').length>0}return t.value.trim()},addValidationError:function(t){BX.addClass(t,"is-invalid");var e=t.closest(".form-group");e&&BX.addClass(e,"has-error")},clearValidationErrors:function(){for(var t=this.form.querySelectorAll(".is-invalid"),e=0;e<t.length;e++)BX.removeClass(t[e],"is-invalid");for(var s=this.form.querySelectorAll(".has-error"),i=0;i<s.length;i++)BX.removeClass(s[i],"has-error")},submitWithRecaptcha:function(){var t=this;this.recaptchaLoaded&&"undefined"!=typeof grecaptcha?grecaptcha.ready(function(){grecaptcha.execute(t.params.recaptchaPublicKey,{action:"submit"}).then(function(e){var s=document.createElement("input");s.type="hidden",s.name="g-recaptcha-response",s.value=e,t.form.appendChild(s),t.submitForm()})}):this.showMessage("Ошибка загрузки reCAPTCHA","error")},submitForm:function(){this.isSubmitting=!0,this.setSubmitButtonState(!0);var t={};Array.from(this.form.elements).forEach(function(e){e.name&&"button"!==e.type&&"submit"!==e.type&&("checkbox"===e.type||"radio"===e.type?e.checked&&(t[e.name]?(Array.isArray(t[e.name])||(t[e.name]=[t[e.name]]),t[e.name].push(e.value)):t[e.name]=e.value):t[e.name]=e.value||"")}),BX.ajax({method:"POST",url:window.location.href,data:t,processData:!1,contentType:!1,onsuccess:BX.proxy(this.onSuccess,this),onfailure:BX.proxy(this.onFailure,this)})},onSuccess:function(t){this.isSubmitting=!1,this.setSubmitButtonState(!1);try{var e=JSON.parse(t);e.success?(this.showMessage(e.message,"success"),this.resetForm(),setTimeout(BX.proxy(this.hideModal,this),2e3)):this.showMessage(e.message,"error")}catch(t){this.showMessage("Ошибка обработки ответа","error")}},onFailure:function(){this.isSubmitting=!1,this.setSubmitButtonState(!1),this.showMessage("Ошибка отправки формы","error")},setSubmitButtonState:function(t){this.submitButton&&(this.submitButton.disabled=t,this.submitButton.innerHTML=t?"Отправляется...":"Отправить")},resetForm:function(){this.form.reset(),this.clearValidationErrors()},hideModal:function(){if(this.modal){var t=bootstrap.Modal.getInstance(this.modal);if(t)t.hide();else new bootstrap.Modal(this.modal).hide()}},onModalHidden:function(){this.resetForm(),this.hideMessage()},showMessage:function(t,e){this.messagesBlock&&(this.messagesBlock.innerHTML=t,this.messagesBlock.className="alert alert-"+("success"===e?"success":"danger"),this.messagesBlock.style.display="block")},hideMessage:function(){this.messagesBlock&&(this.messagesBlock.style.display="none",this.messagesBlock.innerHTML="")}};