BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.ExportProfileManager=function(e){this.params=e||{},this.currentProfileId=null,this.availableFields=[],this.ajaxUrl=e&&e.ajaxUrl?e.ajaxUrl:window.location.href,this.sessid=BX.bitrix_sessid(),this.init()},BX.DDAPP.Tools.ExportProfileManager.prototype={init:function(){console.log("ExportProfileManager: Params",this.params),this.toggleButtons(!1),this.bindEvents(),this.loadProfiles(""),this.loadIblockTypes()},bindEvents:function(){var e=this,t=document.getElementById("profile_select");t?BX.bind(t,"change",function(){this.value?e.loadProfile(this.value):(e.resetForm(),e.toggleSettings(!1),e.toggleFieldsSelection(!1),e.hideExportSettings())}):console.warn("ExportProfileManager: Select profiles not found");var o=document.getElementById("create_profile_btn");o&&BX.bind(o,"click",function(){e.createNewProfile()});var n=document.getElementById("delete_profile_btn");n&&BX.bind(n,"click",function(){e.deleteProfile()});var r=document.getElementById("iblock_type_select");r&&BX.bind(r,"change",function(){e.loadIblocks(this.value)});var i=document.getElementById("iblock_select");i&&BX.bind(i,"change",function(){this.value?e.loadIblockFields(this.value):e.toggleFieldsSelection(!1)});var l=document.getElementById("export_type_select");l&&BX.bind(l,"change",function(){e.showExportSettings(this.value)});var a=document.getElementById("select_all_fields");a&&BX.bind(a,"click",function(){e.selectAllFields(!0)});var s=document.getElementById("deselect_all_fields");s&&BX.bind(s,"click",function(){e.selectAllFields(!1)});var c=document.getElementById("data_export_form");c&&BX.bind(c,"submit",function(t){BX.PreventDefault(t),e.saveProfile()});var d=document.getElementById("cancel_btn");d&&BX.bind(d,"click",function(){e.toggleSettings(!1),e.resetForm()})},createNewProfile:function(){this.currentProfileId=null,this.resetForm(),this.toggleButtons(!0),this.toggleSettings(!0)},loadProfiles:function(e){var t=this;BX.showWait(),this.makeRequest("get_profiles",{},function(t){BX.closeWait();var o=document.getElementById("profile_select");o&&(o.innerHTML='<option value="">'+BX.message("DDAPP_EXPORT_SETTINGS_PROFILE_SELECT")+"</option>",t.data&&t.data.length&&t.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,o.appendChild(t)}),e&&(o.value=e))},function(e){BX.closeWait(),t.showError(BX.message("DDAPP_EXPORT_MESSAGE_PROFILE_ERROR")),console.error("ExportProfileManager: Load Profile Error",e)})},loadProfile:function(e){var t=this;BX.showWait(),this.makeRequest("get_profile",{profile_id:e},function(o){var n=o.data;t.toggleButtons(!0),t.currentProfileId=e,t.fillForm(n),t.toggleSettings(!0),n.IBLOCK_TYPE_ID?t.loadIblocks(n.IBLOCK_TYPE_ID,function(){var e=document.getElementById("iblock_select");e&&(e.value=n.IBLOCK_ID),n.IBLOCK_ID?t.loadIblockFields(n.IBLOCK_ID,function(){n.EXPORT_TYPE&&(t.showExportSettings(n.EXPORT_TYPE),t.fillExportSettings(n.SETTINGS)),BX.closeWait()}):BX.closeWait()}):BX.closeWait()},function(e){BX.closeWait(),t.showError(BX.message("DDAPP_EXPORT_MESSAGE_PROFILE_ERROR")),console.error("ExportProfileManager: Load Profile Error",e)})},deleteProfile:function(){var e=this,t=document.getElementById("profile_select");if(!t)return;var o=t.value;if(!o)return void this.showAlert(BX.message("DDAPP_EXPORT_MESSAGE_PROFILE_SELECT_ERROR"));BX.UI.Dialogs.MessageBox.create({message:BX.message("DDAPP_EXPORT_MESSAGE_BEFORE_DELETE"),title:BX.message("DDAPP_EXPORT_MESSAGE_TITLE"),buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:function(t){e.doDeleteProfile(o),t.close()}}).show()},doDeleteProfile:function(e){var t=this;BX.showWait(),this.makeRequest("delete_profile",{profile_id:e},function(){BX.closeWait(),t.loadProfiles(""),t.toggleSettings(!1),t.resetForm(),t.showAlert(BX.message("DDAPP_EXPORT_MESSAGE_PROFILE_DELETE"))},function(e){BX.closeWait(),t.showError(BX.message("DDAPP_EXPORT_MESSAGE_PROFILE_DELETE_ERROR")),console.error("ExportProfileManager: Delete Profile Error",e)})},loadIblockTypes:function(){var e=this;this.makeRequest("get_iblock_types",{},function(e){var t=document.getElementById("iblock_type_select");t&&(t.innerHTML='<option value="">'+BX.message("DDAPP_EXPORT_SETTINGS_IBLOCK_TYPE_SELECT")+"</option>",e.data&&e.data.length&&e.data.forEach(function(e){var o=document.createElement("option");o.value=e.ID,o.textContent=e.NAME||e.ID,t.appendChild(o)}))},function(t){e.showError(BX.message("DDAPP_EXPORT_MESSAGE_IBLOCK_TYPE_ERROR")),console.error("ExportProfileManager: Load Profile Type Error",t)})},loadIblocks:function(e,t){var o=document.getElementById("iblock_select");if(o)return e?void this.makeRequest("get_iblocks",{type_id:e},function(e){o.innerHTML='<option value="">'+BX.message("DDAPP_EXPORT_SETTINGS_IBLOCK_SELECT")+"</option>",e.data&&e.data.length&&e.data.forEach(function(e){var t=document.createElement("option");t.value=e.ID,t.textContent=e.NAME,o.appendChild(t)}),o.disabled=!1,t&&t()},function(e){console.error("ExportProfileManager: Load Profile Error",e)}):(o.innerHTML='<option value="">'+BX.message("DDAPP_EXPORT_SETTINGS_IBLOCK_SELECT_FIRST")+"</option>",o.disabled=!0,void this.toggleFieldsSelection(!1))},loadIblockFields:function(e,t){var o=this;e?this.makeRequest("get_iblock_fields",{iblock_id:e},function(e){o.availableFields=e.data,o.renderFieldsSelection(),o.toggleFieldsSelection(!0),t&&t()},function(e){console.error("ExportProfileManager: Load Iblock Fields Error",e)}):this.toggleFieldsSelection(!1)},saveProfile:function(){var e=this,t=document.getElementById("data_export_form");if(t){var o=new FormData(t),n={};for(var r of o.entries()){var i=r[0],l=r[1];0!==i.indexOf("settings[")&&(n[i]=l)}var a={},s=[],c=document.getElementById("fields_container");if(c)c.querySelectorAll(".field-item").forEach(function(e){var t=e.querySelector('input[type="checkbox"]');t&&t.checked&&s.push(t.value)});for(var r of o.entries()){i=r[0],l=r[1];if(0===i.indexOf("settings[")&&"settings[export_fields][]"!==i){var d=i.match(/settings\[(.+)\]/)[1];a[d]=l}}s.length>0&&(a.export_fields=s),t.querySelectorAll('input[type="checkbox"][name^="settings["]').forEach(function(e){if("settings[export_fields][]"!==e.name){var t=e.name.match(/settings\[(.+)\]/)[1];void 0===a[t]&&(a[t]=e.checked?"Y":"N")}}),n.settings=a,n.action="save_profile",BX.showWait(),this.makeRequest("save_profile",n,function(t){if(BX.closeWait(),e.showAlert(t.message),!e.currentProfileId&&t.id){e.currentProfileId=t.id;var o=document.getElementById("profile_id");o&&(o.value=t.id)}e.loadProfiles(e.currentProfileId)},function(t){BX.closeWait(),e.showError(BX.message("DDAPP_EXPORT_MESSAGE_PROFILE_SAVE_ERROR")),console.error("ExportProfileManager: Save Profile Error",t)})}},makeRequest:function(e,t,o,n){(t=t||{}).action=e,t.sessid=this.sessid,BX.ajax({url:this.ajaxUrl,method:"POST",data:t,dataType:"json",onsuccess:function(e){e&&e.success?o&&o(e):n&&(console.error("ExportProfileManager: Connect Error",e),n(e&&e.message?e.message:BX.message("DDAPP_EXPORT_MESSAGE_ERROR_SERVER_CONNECT")))},onfailure:function(e){n&&(console.error("ExportProfileManager: Connect Error",e),n(BX.message("DDAPP_EXPORT_MESSAGE_ERROR_SERVER_CONNECT")))}})},renderFieldsSelection:function(){var e=document.getElementById("fields_container");if(e){e.innerHTML="";var t={FIELD:BX.message("DDAPP_EXPORT_SETTINGS_IBLOCK_FIELD"),PROPERTY:BX.message("DDAPP_EXPORT_SETTINGS_IBLOCK_PROPERTY")},o=this;Object.keys(t).forEach(function(n){var r=o.availableFields.filter(function(e){return e.TYPE===n});if(0!==r.length){var i=document.createElement("div");i.className="field-group";var l=document.createElement("h3");l.textContent=t[n],i.appendChild(l);var a=document.createElement("div");a.className="sortable-container",a.setAttribute("data-group",n),r.forEach(function(e){var t=document.createElement("div");t.className="field-item",t.setAttribute("draggable","true"),t.setAttribute("data-field-code",e.CODE);var o=document.createElement("span");o.className="drag-handle",o.innerHTML="⋮⋮";var n=document.createElement("input");n.type="checkbox",n.name="settings[export_fields][]",n.value=e.CODE,n.id="field_"+e.CODE,n.className="field-checkbox";var r=document.createElement("label");r.setAttribute("for","field_"+e.CODE),r.textContent=e.NAME+" ["+e.CODE+"]",r.className="field-label",t.appendChild(o),t.appendChild(n),t.appendChild(r),a.appendChild(t)}),i.appendChild(a),e.appendChild(i)}}),this.initDragAndDrop()}},initDragAndDrop:function(){var e=document.querySelectorAll(".sortable-container"),t=this;e.forEach(function(e){t.makeSortable(e)})},makeSortable:function(e){var t=this,o=null,n=null;e.addEventListener("dragstart",function(e){var t=e.target.closest(".field-item");t&&(o=t,t.classList.add("dragging"),(n=document.createElement("div")).className="field-item",n.style.height=t.offsetHeight+"px",n.style.background="#e3f2fd",n.style.border="1px dashed #2196f3",n.style.opacity="0.5",n.innerHTML='<span style="color: #2196f3; text-align: center; display: block;"></span>',e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",t.outerHTML)))}),e.addEventListener("dragend",function(e){o&&(o.classList.remove("dragging"),o=null),n&&n.parentNode&&(n.parentNode.removeChild(n),n=null)}),e.addEventListener("dragover",function(r){if(r.preventDefault(),r.dataTransfer&&(r.dataTransfer.dropEffect="move"),o&&n){var i=t.getDragAfterElement(e,r.clientY);null==i?e.appendChild(n):e.insertBefore(n,i)}}),e.addEventListener("drop",function(e){e.preventDefault(),o&&n&&(n.parentNode.replaceChild(o,n),t.updateFieldsOrder())})},getDragAfterElement:function(e,t){return Array.from(e.querySelectorAll(".field-item:not(.dragging)")).reduce(function(e,o){var n=o.getBoundingClientRect(),r=t-n.top-n.height/2;return r<0&&r>e.offset?{offset:r,element:o}:e},{offset:Number.NEGATIVE_INFINITY}).element},updateFieldsOrder:function(){var e=document.getElementById("fields_container");if(e){var t=e.querySelectorAll(".field-item"),o=[];t.forEach(function(e,t){var n=e.getAttribute("data-field-code"),r=e.querySelector('input[type="checkbox"]');r&&n&&(r.setAttribute("data-sort-order",t),o.push({code:n,order:t,selected:r.checked}))}),this.fieldsOrder=o}},toggleFieldsSelection:function(e){document.querySelectorAll(".fields-selection").forEach(function(t){t.style.display=e?"table-row":"none"})},selectAllFields:function(e){document.querySelectorAll('input[name="settings[export_fields][]"]').forEach(function(t){t.checked=e})},showExportSettings:function(e){this.hideExportSettings();var t={xls:".excel-settings",csv:".csv-settings"}[e];t&&document.querySelectorAll(t).forEach(function(e){e.style.display="table-row"})},hideExportSettings:function(){[".excel-settings",".csv-settings"].forEach(function(e){document.querySelectorAll(e).forEach(function(e){e.style.display="none"})})},fillForm:function(e){var t=document.getElementById("profile_id");t&&(t.value=e.ID);var o=document.getElementById("profile_name");o&&(o.value=e.NAME);var n=document.getElementById("iblock_type_select");n&&(n.value=e.IBLOCK_TYPE_ID||"");var r=document.getElementById("export_type_select");r&&(r.value=e.EXPORT_TYPE||"")},fillExportSettings:function(e){if(e)try{var t=JSON.parse(e);console.log("ExportProfileManager: Profile settings",t),"string"==typeof t&&(t=JSON.parse(t));var o=this;"object"!=typeof t||Array.isArray(t)||Object.keys(t).forEach(function(e){if("export_fields"===e&&Array.isArray(t[e]))o.restoreFieldsOrder(t[e]);else{var n=document.querySelector('[name="settings['+e+']"]');n&&("checkbox"===n.type?n.checked="Y"===t[e]:n.value=t[e])}})}catch(e){console.error("ExportProfileManager: Settings Parser Error",e)}},toggleSettings:function(e){if(document.querySelectorAll(".profile-settings").forEach(function(t){t.style.display=e?"table-row":"none"}),!e){var t=document.getElementById("profile_select");t&&(t.value="")}},toggleButtons:function(e){["submit_btn","cancel_btn"].forEach(t=>{const o=document.getElementById(t);o&&(o.disabled=!e)})},resetForm:function(){var e=document.getElementById("data_export_form");e&&e.reset&&e.reset();var t=document.getElementById("profile_id");t&&(t.value="");var o=document.getElementById("iblock_select");o&&(o.innerHTML='<option value="">'+BX.message("DDAPP_EXPORT_SETTINGS_IBLOCK_SELECT_FIRST")+"</option>",o.disabled=!0),this.toggleButtons(!1),this.toggleSettings(!1),this.toggleFieldsSelection(!1),this.hideExportSettings(),this.currentProfileId=null,this.availableFields=[]},restoreFieldsOrder:function(e){if(e&&Array.isArray(e)){e.forEach(function(e){var t=document.querySelector('input[value="'+e+'"]');t&&(t.checked=!0)}),document.querySelectorAll(".sortable-container").forEach(function(t){var o=Array.from(t.querySelectorAll(".field-item")),n=[];e.forEach(function(e){var t=o.find(function(t){return t.getAttribute("data-field-code")===e});t&&n.push(t)}),o.forEach(function(e){-1===n.indexOf(e)&&n.push(e)}),n.forEach(function(e){t.appendChild(e)})})}},showAlert:function(e){BX.UI.Dialogs.MessageBox.alert(e,BX.message("DDAPP_EXPORT_MESSAGE_TITLE"))},showError:function(e){BX.UI.Dialogs.MessageBox.alert(e,BX.message("DDAPP_EXPORT_MESSAGE_ERROR"))}};