BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.FormManager=function(o){this.params=o||{},this.componentId=o.componentId,this.button=o.button,this.ajaxUrl=o.ajaxUrl,this.modalTitle=o.modalTitle,this.inputPlaceholder=o.inputPlaceholder,this.ajaxUrl=o&&o.ajaxUrl?o.ajaxUrl:window.location.href,this.modalLoaded=!1,this.init()},BX.DDAPP.Tools.FormManager.prototype={init:function(){console.log("FormManager: Params",this.params),this.button&&this.button.addEventListener("click",this.handleButtonClick.bind(this))},handleButtonClick:function(o){o.preventDefault(),this.modalLoaded?this.showModal():this.loadModal()},loadModal:function(){var o={component_action:"load_modal",component_id:this.componentId,modal_title:this.modalTitle,input_placeholder:this.inputPlaceholder,template:this.button.getAttribute("data-template"),sessid:BX.bitrix_sessid()};console.log("Loading modal for component:",this.componentId),console.log("Post data:",o),BX.ajax({url:this.ajaxUrl,method:"POST",data:o,dataType:"json",onsuccess:this.onModalLoaded.bind(this),onfailure:this.onLoadError.bind(this)})},onModalLoaded:function(o){console.log("Modal loaded:",o),o&&"success"===o.status?(document.body.insertAdjacentHTML("beforeend",o.html),this.modalLoaded=!0,this.initFormHandlers(),this.showModal(),this.setupModalCleanup()):(console.error("Unexpected response:",o),this.showError("Ошибка загрузки формы"))},onLoadError:function(o){console.error("Modal load error:",o),this.showError("Ошибка загрузки модального окна")},showModal:function(){var o=document.getElementById(this.componentId+"_modal");o&&(new bootstrap.Modal(o,{backdrop:!0,keyboard:!0,focus:!0}).show(),o.addEventListener("shown.bs.modal",function(){var t=o.querySelector('input[type="text"]');t&&t.focus()},{once:!0}))},setupModalCleanup:function(){var o=document.getElementById(this.componentId+"_modal"),t=this;o&&(o.addEventListener("hide.bs.modal",function(){var e=o.querySelector(":focus");e&&e.blur(),t.button&&setTimeout(function(){t.button.focus()},100)}),o.addEventListener("hidden.bs.modal",function(){this.remove(),t.modalLoaded=!1}))},initFormHandlers:function(){var o=document.getElementById(this.componentId+"_form"),t=document.getElementById(this.componentId+"_input"),e=document.getElementById(this.componentId+"_message");o&&o.addEventListener("submit",function(o){o.preventDefault(),this.handleFormSubmit(t.value,e)}.bind(this))},handleFormSubmit:function(o,t){var e={component_action:"check_value",component_id:this.componentId,value:o,sessid:BX.bitrix_sessid()};console.log("Submitting form for component:",this.componentId),console.log("Value:",o),console.log("Post data:",e),BX.ajax({url:this.ajaxUrl,method:"POST",data:e,dataType:"json",onsuccess:function(o){this.onFormResponse(o,t)}.bind(this),onfailure:function(o){this.onFormError(o,t)}.bind(this)})},onFormResponse:function(o,t){console.log("Form response:",o),o&&o.status?this.showMessage(t,o.message,o.status):(console.error("Invalid response format:",o),this.showMessage(t,"Ошибка формата ответа","error"))},onFormError:function(o,t){console.error("Form submission error:",o),this.showMessage(t,"Ошибка отправки запроса","error")},showMessage:function(o,t,e){o&&(o.className="alert",o.classList.remove("d-none","alert-success","alert-danger"),"success"===e?o.classList.add("alert-success"):o.classList.add("alert-danger"),o.textContent=t)},showError:function(o){console.error("DDAppModalForm Error:",o),alert("Ошибка: "+o)},destroy:function(){this.button&&this.button.removeEventListener("click",this.handleButtonClick);var o=document.getElementById(this.componentId+"_modal");o&&o.remove(),this.modalLoaded=!1}};