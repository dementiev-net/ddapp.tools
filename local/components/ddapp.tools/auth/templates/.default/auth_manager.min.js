BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.AuthManager=function(t){this.params=t||{},this.componentId=t.componentId,this.buttons=t.buttons,this.ajaxUrl=t.ajaxUrl,this.authParams={},this.modalsLoaded={login:!1,register:!1,forgot:!1},this.init()},BX.DDAPP.Tools.AuthManager.prototype={init:function(){if(console.log("AuthManager: Params",this.params),this.ensureToastContainer(),this.authParams=JSON.parse(this.buttons.login?.getAttribute("data-auth-params")||"{}"),0===Object.keys(this.authParams).length)return console.error("AuthManager: The authParams is empty",this.authParams),void this.showToast("Ошибка в параметрах авторизации","error");this.bindButtonEvents()},ensureToastContainer:function(){var t="ddapp-toast-container",e=document.getElementById(t);e||((e=document.createElement("div")).id=t,e.className="toast-container position-fixed top-0 end-0 p-3",e.style.zIndex="9999",document.body.appendChild(e)),this.toastContainer=e},showToast:function(t,e,o){e=e||"info",o=o||5e3;var s="toast_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),n={success:{bgClass:"bg-success"},error:{bgClass:"bg-danger"},warning:{bgClass:"bg-warning text-dark"},info:{bgClass:"bg-info"}},i=`\n            <div id="${s}" class="toast align-items-center text-white ${(n[e]||n.info).bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">\n                <div class="d-flex">\n                    <div class="toast-body">\n                        ${t}\n                    </div>\n                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Закрыть"></button>\n                </div>\n            </div>`;this.toastContainer.insertAdjacentHTML("beforeend",i);var a=document.getElementById(s),r=new bootstrap.Toast(a,{delay:o,autohide:!0});return a.addEventListener("hidden.bs.toast",function(){a.remove()}),r.show(),r},bindButtonEvents:function(){this.buttons.login&&this.buttons.login.addEventListener("click",this.handleLoginClick.bind(this)),this.buttons.register&&this.buttons.register.addEventListener("click",this.handleRegisterClick.bind(this)),this.buttons.logout&&this.buttons.logout.addEventListener("click",this.handleLogoutClick.bind(this))},handleLoginClick:function(t){t.preventDefault(),this.loadModal("login")},handleRegisterClick:function(t){t.preventDefault(),this.loadModal("register")},handleLogoutClick:function(t){t.preventDefault(),this.logout()},loadModal:function(t){if(this.modalsLoaded[t])this.showModal(t);else{var e={action:"load_"+t,id:this.componentId,"auth-params":this.authParams,sessid:BX.bitrix_sessid()};console.log("AuthManager: Loading modal",t,e),BX.ajax({url:this.ajaxUrl,method:"POST",data:e,dataType:"json",onsuccess:this.onModalLoaded.bind(this,t),onfailure:this.onLoadError.bind(this)})}},onModalLoaded:function(t,e){e&&e.success?(document.body.insertAdjacentHTML("beforeend",e.html),this.modalsLoaded[t]=!0,this.initFormHandlers(t),this.showModal(t),this.setupModalCleanup(t)):(console.error("AuthManager: Unexpected response",e),this.showToast(e&&e.message?e.message:"Ошибка загрузки формы","error"))},onLoadError:function(t){console.error("AuthManager: Modal load error",t),this.showToast("Ошибка загрузки модального окна","error")},showModal:function(t){var e=document.getElementById(this.componentId+"_"+t+"_modal");e&&(new bootstrap.Modal(e,{backdrop:!0,keyboard:!0,focus:!0}).show(),e.addEventListener("shown.bs.modal",function(){var t=e.querySelector('input[type="text"], input[type="email"]');t&&t.focus()},{once:!0}))},setupModalCleanup:function(t){var e=document.getElementById(this.componentId+"_"+t+"_modal"),o=this;e&&e.addEventListener("hidden.bs.modal",function(){this.remove(),o.modalsLoaded[t]=!1})},initFormHandlers:function(t){var e=document.getElementById(this.componentId+"_"+t+"_form"),o=document.getElementById(this.componentId+"_"+t+"_message");e&&(e.addEventListener("submit",function(s){s.preventDefault(),this.handleFormSubmit(t,e,o)}.bind(this)),this.initFormSwitching(t))},initFormSwitching:function(t){var e=document.getElementById(this.componentId+"_"+t+"_modal");if(e){var o=e.querySelector(".forgot-password-link");o&&o.addEventListener("click",function(t){t.preventDefault(),bootstrap.Modal.getInstance(e).hide(),setTimeout(()=>{this.loadModal("forgot")},300)}.bind(this));var s=e.querySelector(".register-link");s&&s.addEventListener("click",function(t){t.preventDefault(),bootstrap.Modal.getInstance(e).hide(),setTimeout(()=>{this.loadModal("register")},300)}.bind(this));var n=e.querySelector(".login-link");n&&n.addEventListener("click",function(t){t.preventDefault(),bootstrap.Modal.getInstance(e).hide(),setTimeout(()=>{this.loadModal("login")},300)}.bind(this));var i=e.querySelector(".back-to-login-link");i&&i.addEventListener("click",function(t){t.preventDefault(),bootstrap.Modal.getInstance(e).hide(),setTimeout(()=>{this.loadModal("login")},300)}.bind(this))}},handleFormSubmit:function(t,e,o){var s=new FormData(e),n={action:"login"===t?"auth":t,id:this.componentId,"auth-params":this.authParams,sessid:BX.bitrix_sessid()};for(var i of s.entries())n[i[0]]=i[1];console.log("AuthManager: Submitting form",t,n),BX.ajax({url:this.ajaxUrl,method:"POST",data:n,dataType:"json",onsuccess:function(e){this.onFormResponse(t,e,o)}.bind(this),onfailure:function(e){this.onFormError(t,e,o)}.bind(this)})},onFormResponse:function(t,e,o){console.log("AuthManager: Form response",t,e),e&&e.success?(this.showToast(e.message||"Операция выполнена успешно!","success"),setTimeout(function(){var o=bootstrap.Modal.getInstance(document.getElementById(this.componentId+"_"+t+"_modal"));o&&o.hide(),e.redirect?window.location.href=e.redirect:"login"!==t&&"register"!==t||window.location.reload()}.bind(this),2e3)):this.showMessage(o,e.message,"error")},onFormError:function(t,e,o){console.error("AuthManager: Form submission error",t,e),this.showToast("Ошибка отправки запроса","error")},showMessage:function(t,e,o){t&&(t.className="alert",t.classList.remove("d-none","alert-success","alert-danger"),"success"===o?t.classList.add("alert-success"):t.classList.add("alert-danger"),t.textContent=e)},logout:function(){var t={action:"logout",id:this.componentId,"auth-params":this.authParams,sessid:BX.bitrix_sessid()};BX.ajax({url:this.ajaxUrl,method:"POST",data:t,dataType:"json",onsuccess:function(t){t&&t.success&&(this.showToast(t.message||"Вы успешно вышли из системы","success"),setTimeout(function(){t.redirect?window.location.href=t.redirect:window.location.reload()},1e3))}.bind(this),onfailure:function(t){console.error("AuthManager: Logout error",t),this.showToast("Ошибка при выходе из системы","error")}.bind(this)})},destroy:function(){this.buttons.login&&this.buttons.login.removeEventListener("click",this.handleLoginClick),this.buttons.register&&this.buttons.register.removeEventListener("click",this.handleRegisterClick),this.buttons.logout&&this.buttons.logout.removeEventListener("click",this.handleLogoutClick),["login","register","forgot"].forEach(function(t){var e=document.getElementById(this.componentId+"_"+t+"_modal");e&&e.remove()}.bind(this)),this.modalsLoaded={login:!1,register:!1,forgot:!1}}};