BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.LogViewer=function(e){this.params=e||{},this.ajaxUrl=e&&e.ajaxUrl?e.ajaxUrl:window.location.href,this.currentPage=1,this.currentFilename="",this.debounceTimer=null,this.refreshFiles=null,this.logFileSelect=null,this.clearFilters=null,this.clearLog=null,this.prevPage=null,this.nextPage=null,this.levelFilter=null,this.userFilter=null,this.dateFilter=null,this.searchFilter=null,this.totalCount=null,this.debugCount=null,this.infoCount=null,this.warningCount=null,this.errorCount=null,this.criticalCount=null,this.logEntries=null,this.pagination=null,this.paginationInfo=null,this.pageNumbers=null,this.init()},BX.DDAPP.Tools.LogViewer.prototype={init:function(){console.log("LogViewer: Params",this.params),this.initElements(),this.bindEvents(),this.loadLogFiles()},initElements:function(){this.refreshFiles=BX("refresh-files"),this.logFileSelect=BX("log-file-select"),this.clearFilters=BX("clear-filters"),this.clearLog=BX("clear-log"),this.prevPage=BX("prev-page"),this.nextPage=BX("next-page"),this.levelFilter=BX("level-filter"),this.userFilter=BX("user-filter"),this.dateFilter=BX("date-filter"),this.searchFilter=BX("search-filter"),this.totalCount=BX("total-count"),this.debugCount=BX("debug-count"),this.infoCount=BX("info-count"),this.warningCount=BX("warning-count"),this.errorCount=BX("error-count"),this.criticalCount=BX("critical-count"),this.logEntries=BX("log-entries"),this.pagination=BX("pagination"),this.paginationInfo=BX("pagination-info"),this.pageNumbers=BX("page-numbers")},bindEvents:function(){var e=this;BX.bind(this.refreshFiles,"click",function(){e.loadLogFiles(this.value)}),BX.bind(this.logFileSelect,"change",function(){e.onSelectLogFile(this.value)}),BX.bind(this.clearFilters,"click",function(){e.onClearFilters()}),BX.bind(this.clearLog,"click",function(){e.onClearLog()}),BX.bind(this.prevPage,"click",function(){e.onPrevPage()}),BX.bind(this.nextPage,"click",function(){e.onNextPage()}),BX.bind(this.levelFilter,"change",function(){e.applyFilters()}),BX.bind(this.userFilter,"change",function(){e.applyFilters()}),BX.bind(this.dateFilter,"change",function(){e.applyFilters()}),BX.bind(this.searchFilter,"input",function(){e.debounceApplyFilters()})},debounceApplyFilters:function(){var e=this;this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(function(){e.applyFilters()},500)},loadLogFiles:function(){var e=this;BX.showWait(),BX.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{action:"get_log_files",sessid:BX.bitrix_sessid()},onsuccess:function(t){BX.closeWait(),e.updateLogFilesSelect(t)},onfailure:function(){BX.closeWait(),console.error("LogViewer: Load Files Error"),e.showError(e.params.messageErrorLoadFile)}})},updateLogFilesSelect:function(e){var t=this.logFileSelect;t.innerHTML='<option value="">'+this.params.messageSelectLogFile+"</option>";for(var i=0;i<e.length;i++){var a=BX.create("option",{props:{value:e[i],textContent:e[i]}});t.appendChild(a)}},onSelectLogFile:function(e){this.currentFilename=e,this.currentPage=1,e?this.loadLogData():this.clearTable()},loadLogData:function(){if(this.currentFilename){BX.showWait();var e=this,t=this.getFilters();BX.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{action:"get_log_data",filename:this.currentFilename,filters:JSON.stringify(t),page:this.currentPage,sessid:BX.bitrix_sessid()},onsuccess:function(t){BX.closeWait(),e.updateStats(t.stats),e.updateUserFilter(t.users),e.updateTable(t.entries),e.updatePagination(t.pagination)},onfailure:function(){BX.closeWait(),console.error("LogViewer: Load Data Error"),e.showError(e.params.messageErrorLoadData)}})}},getFilters:function(){return{level:this.levelFilter.value,user:this.userFilter.value,date:this.dateFilter.value,search:this.searchFilter.value}},updateStats:function(e){this.totalCount.textContent=e.total,this.debugCount.textContent=e.debug,this.infoCount.textContent=e.info,this.warningCount.textContent=e.warning,this.errorCount.textContent=e.error,this.criticalCount.textContent=e.critical},updateUserFilter:function(e){var t=this.userFilter,i=t.value;t.innerHTML='<option value="">'+this.params.messageAllUsers+"</option>";for(var a=0;a<e.length;a++){var s=BX.create("option",{props:{value:e[a],textContent:e[a]}});e[a]===i&&(s.selected=!0),t.appendChild(s)}},updateTable:function(e){var t=this.logEntries;if(0!==e.length){for(var i="",a=0;a<e.length;a++){var s=e[a],r=BX.util.htmlspecialchars(s.message);r=(r=r.replace(/\\\//g,"/")).replace(/ \| /g,"<br>"),i+='<tr class="log-entry" style="border-bottom: none;"><td class="log-datetime" rowspan="2">'+BX.util.htmlspecialchars(s.datetime)+'</td><td><span class="log-level level-'+s.level+'">'+s.level+'</span></td><td class="log-user">'+BX.util.htmlspecialchars(s.user)+'</td><td class="log-url">'+BX.util.htmlspecialchars(s.url)+'</td><td class="log-memory">'+BX.util.htmlspecialchars(s.memory)+" / "+BX.util.htmlspecialchars(s.peak)+'</td></tr><tr><td colspan="4" class="log-message">'+r+"</td></tr>"}t.innerHTML=i}else t.innerHTML='<tr><td colspan="5" class="no-data">'+this.params.messageDataNotFound+"</td></tr>"},updatePagination:function(e){var t=this.pagination;e.pages<=1?t.style.display="none":(t.style.display="flex",this.paginationInfo.textContent="Показано "+(5*(e.current_page-1)+1)+"-"+Math.min(5*e.current_page,e.total)+" "+this.params.messagePageFrom+" "+e.total,this.prevPage.disabled=1===e.current_page,this.nextPage.disabled=e.current_page===e.pages,this.generatePageNumbers(e))},generatePageNumbers:function(e){var t=this.pageNumbers,i=this;BX.cleanNode(t);var a=Math.max(1,e.current_page-Math.floor(2.5)),s=Math.min(e.pages,a+5-1);s-a+1<5&&(a=Math.max(1,s-5+1));for(var r=a;r<=s;r++){var n=BX.create("a",{props:{href:"#",className:"page-number"+(r===e.current_page?" active":""),textContent:r},attrs:{"data-page":r}});BX.bind(n,"click",function(e){e.preventDefault();var t=parseInt(this.getAttribute("data-page"));i.goToPage(t)}),t.appendChild(n)}},clearTable:function(){this.logEntries.innerHTML='<tr><td colspan="5" class="no-data">'+this.params.messageDataNotFound+"</td></tr>",this.pagination.style.display="none",this.updateStats({total:0,debug:0,info:0,warning:0,error:0,critical:0})},applyFilters:function(){this.currentPage=1,this.loadLogData()},onClearFilters:function(){this.levelFilter.value="",this.userFilter.value="",this.dateFilter.value="",this.searchFilter.value="",this.applyFilters()},onClearLog:function(){if(!this.currentFilename)return;var e=this;BX.UI.Dialogs.MessageBox.create({message:e.params.messageBeforeDelete,title:e.params.messageTitle,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:function(t){e.performClearLog(),t.close()}}).show()},performClearLog:function(){var e=this;BX.showWait(),BX.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{action:"clear_log",filename:this.currentFilename,sessid:BX.bitrix_sessid()},onsuccess:function(t){BX.closeWait(),t.success?(e.loadLogData(),e.showAlert(e.params.messageDeleteOk)):(console.error("LogViewer Error:",t.message),e.showError(t.message))},onfailure:function(){BX.closeWait(),console.error("LogViewer: Clear Log Error"),e.showError(e.params.messageErrorLogClear)}})},onPrevPage:function(){this.currentPage>1&&(this.currentPage--,this.loadLogData())},onNextPage:function(){this.currentPage++,this.loadLogData()},goToPage:function(e){this.currentPage=e,this.loadLogData()},showAlert:function(e){BX.UI.Dialogs.MessageBox.alert(e,this.params.messageTitle)},showError:function(e){tbody.innerHTML='<tr><td colspan="5" class="no-data">'+this.params.messageDataNotFound+"</td></tr>",BX.UI.Dialogs.MessageBox.alert(e,this.params.messageError)}};