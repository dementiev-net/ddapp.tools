BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.FormManager=function(e){this.params=e||{},this.componentId=e.componentId,this.button=e.button,this.ajaxUrl=e.ajaxUrl,this.formParams={},this.modalLoaded=!1,this.init()},BX.DDAPP.Tools.FormManager.prototype={init:function(){if(console.log("FormManager: Params",this.params),this.ensureToastContainer(),this.formParams=JSON.parse(this.button.getAttribute("data-form-params")||"{}"),0===Object.keys(this.formParams).length)return console.error("FormManager: The formParams is empty",this.formParams),void this.showToast("Ошибка в параметрах формы","error");this.button&&this.button.addEventListener("click",this.handleButtonClick.bind(this))},ensureToastContainer:function(){var e="ddapp-toast-container",t=document.getElementById(e);t||((t=document.createElement("div")).id=e,t.className="toast-container position-fixed top-0 end-0 p-3",t.style.zIndex="9999",document.body.appendChild(t)),this.toastContainer=t},showToast:function(e,t,o){t=t||"info",o=o||5e3;var n="toast_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),a={success:{bgClass:"bg-success"},error:{bgClass:"bg-danger"},warning:{bgClass:"bg-warning text-dark"},info:{bgClass:"bg-info"}},s=`\n            <div id="${n}" class="toast align-items-center text-white ${(a[t]||a.info).bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">\n                <div class="d-flex">\n                    <div class="toast-body">\n                        ${e}\n                    </div>\n                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Закрыть"></button>\n                </div>\n            </div>`;this.toastContainer.insertAdjacentHTML("beforeend",s);var i=document.getElementById(n),r=new bootstrap.Toast(i,{delay:o,autohide:!0});return i.addEventListener("hidden.bs.toast",function(){i.remove()}),r.show(),r},handleButtonClick:function(e){e.preventDefault(),this.modalLoaded?this.showModal():this.loadModal()},loadModal:function(){var e={action:"load",id:this.componentId,"form-params":this.formParams,template:this.button.getAttribute("data-template"),sessid:BX.bitrix_sessid()};console.log("FormManager: Loading modal",e),BX.ajax({url:this.ajaxUrl,method:"POST",data:e,dataType:"json",onsuccess:this.onModalLoaded.bind(this),onfailure:this.onLoadError.bind(this)})},onModalLoaded:function(e){e&&e.success?(document.body.insertAdjacentHTML("beforeend",e.html),this.modalLoaded=!0,this.initFormHandlers(),this.showModal(),this.setupModalCleanup()):(console.error("FormManager: Unexpected response",e),this.showToast(e&&e.message?e.message:"Ошибка загрузки формы","error"))},onLoadError:function(e){console.error("FormManager: Modal load error",e),this.showToast("Ошибка загрузки модального окна","error")},showModal:function(){var e=document.getElementById(this.componentId+"_modal");e&&(new bootstrap.Modal(e,{backdrop:!0,keyboard:!0,focus:!0}).show(),e.addEventListener("shown.bs.modal",function(){var t=e.querySelector('input[type="text"]');t&&t.focus()},{once:!0}))},setupModalCleanup:function(){var e=document.getElementById(this.componentId+"_modal"),t=this;e&&(e.addEventListener("hide.bs.modal",function(){var o=e.querySelector(":focus");o&&o.blur(),t.button&&setTimeout(function(){t.button.focus()},100)}),e.addEventListener("hidden.bs.modal",function(){this.remove(),t.modalLoaded=!1}))},initFileUpload:function(){document.querySelectorAll(".file-upload-area").forEach(function(e){var t=e.querySelector('input[type="file"]'),o=e.querySelector(".file-drop-zone"),n=e.querySelector(".file-preview-list");o.querySelector("button").addEventListener("click",function(e){e.preventDefault(),t.click()}),o.addEventListener("dragover",function(e){e.preventDefault(),o.classList.add("border-primary","bg-light")}),o.addEventListener("dragleave",function(e){e.preventDefault(),o.classList.remove("border-primary","bg-light")}),o.addEventListener("drop",function(e){e.preventDefault(),o.classList.remove("border-primary","bg-light");var a=e.dataTransfer.files;t.files=a,this.showFilePreview(a,n)}.bind(this)),t.addEventListener("change",function(e){this.showFilePreview(e.target.files,n)}.bind(this))}.bind(this))},showFilePreview:function(e,t){t.innerHTML="",Array.from(e).forEach(function(e,o){var n=document.createElement("div");n.className="file-preview-item d-flex align-items-center justify-content-between p-2 border rounded mb-2";var a=document.createElement("div");a.innerHTML='<i class="fas fa-file me-2"></i>'+e.name+' <small class="text-muted">('+this.formatFileSize(e.size)+")</small>";var s=document.createElement("button");s.type="button",s.className="btn btn-sm btn-outline-danger",s.innerHTML='<i class="fas fa-times"></i>',s.addEventListener("click",function(){}),n.appendChild(a),n.appendChild(s),t.appendChild(n)}.bind(this))},formatFileSize:function(e){if(0===e)return"0 Bytes";var t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]},initEmailAutocomplete:function(){var e=document.querySelectorAll('input[type="text"]'),t=["gmail.com","yandex.ru","mail.ru","outlook.com","yahoo.com"];e.forEach(function(e){e.parentElement.querySelector(".email-hint")&&e.addEventListener("keydown",function(o){if("Tab"===o.key&&e.value.includes("@")&&!e.value.includes(".")){o.preventDefault();var n=e.value.indexOf("@"),a=e.value.substring(n+1),s=t.find(e=>e.startsWith(a));s&&(e.value=e.value.substring(0,n+1)+s,e.setSelectionRange(n+1+a.length,e.value.length))}})})},initFormHandlers:function(){var e=document.getElementById(this.componentId+"_form"),t=document.getElementById(this.componentId+"_message");e&&(this.initFileUpload(),this.initEmailAutocomplete(),e.addEventListener("submit",function(e){e.preventDefault(),this.handleFormSubmit("",t)}.bind(this)))},handleFormSubmit:function(e,t){var o={action:"save",id:this.componentId,"form-params":this.formParams,template:this.button.getAttribute("data-template"),sessid:BX.bitrix_sessid()};console.log("FormManager: Submitting form",o),BX.ajax({url:this.ajaxUrl,method:"POST",data:o,dataType:"json",onsuccess:function(e){this.onFormResponse(e,t)}.bind(this),onfailure:function(e){this.onFormError(e,t)}.bind(this)})},onFormResponse:function(e,t){if(console.log("FormManager: Form response",e),e&&e.success){this.showToast(e.message||"Форма успешно отправлена!","success"),setTimeout(function(){var e=bootstrap.Modal.getInstance(document.getElementById(this.componentId+"_modal"));e&&e.hide()}.bind(this),2e3);var o=document.getElementById(this.componentId+"_form");if(o)o.reset(),o.querySelectorAll(".file-preview-list").forEach(function(e){e.innerHTML=""})}else this.showMessage(t,e.message,"error")},onFormError:function(e,t){console.error("FormManager: Form submission error",e),this.showToast("Ошибка отправки запроса","error")},showMessage:function(e,t,o){e&&(e.className="alert",e.classList.remove("d-none","alert-success","alert-danger"),"success"===o?e.classList.add("alert-success"):e.classList.add("alert-danger"),e.textContent=t)},destroy:function(){this.button&&this.button.removeEventListener("click",this.handleButtonClick);var e=document.getElementById(this.componentId+"_modal");e&&e.remove(),this.modalLoaded=!1}};