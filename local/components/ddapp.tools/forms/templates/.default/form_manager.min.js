BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.FormManager=function(t){this.params=t||{},this.componentId=t.componentId,this.button=t.button,this.ajaxUrl=t.ajaxUrl,this.formParams={},this.modalLoaded=!1,this.init()},BX.DDAPP.Tools.FormManager.prototype={init:function(){if(console.log("FormManager: Params",this.params),this.ensureToastContainer(),this.formParams=JSON.parse(this.button.getAttribute("data-form-params")||"{}"),0===Object.keys(this.formParams).length)return console.error("FormManager: The formParams is empty",this.formParams),void this.showToast("Ошибка в параметрах формы","error");this.button&&this.button.addEventListener("click",this.handleButtonClick.bind(this))},ensureToastContainer:function(){var t="ddapp-toast-container",e=document.getElementById(t);e||((e=document.createElement("div")).id=t,e.className="toast-container position-fixed top-0 end-0 p-3",e.style.zIndex="9999",document.body.appendChild(e)),this.toastContainer=e},showToast:function(t,e,o){e=e||"info",o=o||5e3;var n="toast_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),a={success:{bgClass:"bg-success"},error:{bgClass:"bg-danger"},warning:{bgClass:"bg-warning text-dark"},info:{bgClass:"bg-info"}},s=`\n            <div id="${n}" class="toast align-items-center text-white ${(a[e]||a.info).bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">\n                <div class="d-flex">\n                    <div class="toast-body">\n                        ${t}\n                    </div>\n                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Закрыть"></button>\n                </div>\n            </div>`;this.toastContainer.insertAdjacentHTML("beforeend",s);var i=document.getElementById(n),r=new bootstrap.Toast(i,{delay:o,autohide:!0});return i.addEventListener("hidden.bs.toast",function(){i.remove()}),r.show(),r},handleButtonClick:function(t){t.preventDefault(),this.modalLoaded?this.showModal():this.loadModal()},loadModal:function(){var t={action:"load",id:this.componentId,"form-params":this.formParams,template:this.button.getAttribute("data-template"),sessid:BX.bitrix_sessid()};console.log("FormManager: Loading modal",t),BX.ajax({url:this.ajaxUrl,method:"POST",data:t,dataType:"json",onsuccess:this.onModalLoaded.bind(this),onfailure:this.onLoadError.bind(this)})},onModalLoaded:function(t){t&&t.success?(document.body.insertAdjacentHTML("beforeend",t.html),this.modalLoaded=!0,this.initFormHandlers(),this.showModal(),this.setupModalCleanup()):(console.error("FormManager: Unexpected response",t),this.showToast(t&&t.message?t.message:"Ошибка загрузки формы","error"))},onLoadError:function(t){console.error("FormManager: Modal load error",t),this.showToast("Ошибка загрузки модального окна","error")},showModal:function(){var t=document.getElementById(this.componentId+"_modal");t&&(new bootstrap.Modal(t,{backdrop:!0,keyboard:!0,focus:!0}).show(),t.addEventListener("shown.bs.modal",function(){var e=t.querySelector('input[type="text"]');e&&e.focus()},{once:!0}))},setupModalCleanup:function(){var t=document.getElementById(this.componentId+"_modal"),e=this;t&&(t.addEventListener("hide.bs.modal",function(){var o=t.querySelector(":focus");o&&o.blur(),e.button&&setTimeout(function(){e.button.focus()},100)}),t.addEventListener("hidden.bs.modal",function(){this.remove(),e.modalLoaded=!1}))},initFileUpload:function(){document.querySelectorAll(".file-upload-area").forEach(function(t){var e=t.querySelector('input[type="file"]'),o=t.querySelector(".file-drop-zone"),n=t.querySelector(".file-preview-list");o.querySelector("button").addEventListener("click",function(t){t.preventDefault(),e.click()}),o.addEventListener("dragover",function(t){t.preventDefault(),o.classList.add("border-primary","bg-light")}),o.addEventListener("dragleave",function(t){t.preventDefault(),o.classList.remove("border-primary","bg-light")}),o.addEventListener("drop",function(t){t.preventDefault(),o.classList.remove("border-primary","bg-light");var a=t.dataTransfer.files;e.files=a,this.showFilePreview(a,n)}.bind(this)),e.addEventListener("change",function(t){this.showFilePreview(t.target.files,n)}.bind(this))}.bind(this))},showFilePreview:function(t,e){e.innerHTML="",Array.from(t).forEach(function(t,o){var n=document.createElement("div");n.className="file-preview-item d-flex align-items-center justify-content-between p-2 border rounded mb-2";var a=document.createElement("div");a.innerHTML='<i class="fas fa-file me-2"></i>'+t.name+' <small class="text-muted">('+this.formatFileSize(t.size)+")</small>";var s=document.createElement("button");s.type="button",s.className="btn btn-sm btn-outline-danger",s.innerHTML='<i class="fas fa-times"></i>',s.addEventListener("click",function(){}),n.appendChild(a),n.appendChild(s),e.appendChild(n)}.bind(this))},formatFileSize:function(t){if(0===t)return"0 Bytes";var e=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,e)).toFixed(2))+" "+["Bytes","KB","MB","GB"][e]},initInputMasks:function(){"undefined"!=typeof Inputmask?document.querySelectorAll('input[type="text"]').forEach(function(t){var e=t.getAttribute("aria-describedby");if(e){var o=document.getElementById(e);if(o){var n=o.textContent.toUpperCase();n.includes("PHONE")?this.applyPhoneMask(t):n.includes("EMAIL")&&this.applyEmailMask(t)}}}.bind(this)):console.warn("FormManager: Inputmask library not loaded")},applyPhoneMask:function(t){new Inputmask({mask:"+7 (999) 999-99-99",placeholder:"_",showMaskOnHover:!1,showMaskOnFocus:!0,clearIncomplete:!0,definitions:{9:{validator:"[0-9]",cardinality:1}}}).mask(t),t.setAttribute("inputmode","tel"),t.setAttribute("autocomplete","tel")},applyEmailMask:function(t){new Inputmask({mask:"*{1,64}@*{1,64}.*{2,}",greedy:!1,clearIncomplete:!0,definitions:{"*":{validator:"[0-9A-Za-z!#$%&'*+/=?^_`{|}~-]",cardinality:1,casing:"lower"}}}).mask(t),t.setAttribute("inputmode","email"),t.setAttribute("autocomplete","email")},initFormHandlers:function(){var t=document.getElementById(this.componentId+"_form"),e=document.getElementById(this.componentId+"_message");t&&(this.initFileUpload(),this.initInputMasks(),this.validator=new BX.DDAPP.Tools.FormValidator(this.componentId+"_form",this.formParams),this.bindClearErrorsEvents(t,e),t.addEventListener("submit",function(o){o.preventDefault(),this.handleFormSubmit("",t,e)}.bind(this)))},handleFormSubmit:function(t,e,o){var n=new FormData(e),a={action:"save",id:this.componentId,"form-params":this.formParams,template:this.button.getAttribute("data-template"),sessid:BX.bitrix_sessid()};for(var s of n.entries())a[s[0]]=s[1];console.log("FormManager: Submitting form",a),BX.ajax({url:this.ajaxUrl,method:"POST",data:a,dataType:"json",onsuccess:function(t){this.onFormResponse(t,o)}.bind(this),onfailure:function(t){this.onFormError(t,o)}.bind(this)})},bindClearErrorsEvents:function(t,e){var o=this;t.querySelectorAll('input[type="text"], input[type="email"], input[type="password"], input[type="tel"], textarea, select').forEach(function(t){"text"!==t.type&&"email"!==t.type&&"password"!==t.type&&"tel"!==t.type&&"TEXTAREA"!==t.tagName||t.addEventListener("input",function(){o.clearFieldError(this,e)}),"SELECT"!==t.tagName&&"checkbox"!==t.type&&"radio"!==t.type||t.addEventListener("change",function(){o.clearFieldError(this,e)}),"file"===t.type&&t.addEventListener("change",function(){o.clearFieldError(this,e)})})},clearFieldError:function(t,e){this.validator&&this.validator.clearFieldValidation(t),e&&!e.classList.contains("d-none")&&(e.classList.add("d-none"),e.textContent="")},onFormResponse:function(t,e){if(console.log("FormManager: Form response",t),this.validator&&this.validator.clearAllValidation(),t&&t.success){this.showToast(t.message||"Форма успешно отправлена!","success"),setTimeout(function(){var t=bootstrap.Modal.getInstance(document.getElementById(this.componentId+"_modal"));t&&t.hide()}.bind(this),2e3);var o=document.getElementById(this.componentId+"_form");if(o)o.reset(),o.classList.remove("was-validated"),this.validator&&this.validator.clearAllValidation(),o.querySelectorAll(".file-preview-list").forEach(function(t){t.innerHTML=""})}else t.fieldErrors&&this.validator&&(this.validator.showFieldErrors(t.fieldErrors),this.validator.scrollToFirstError()),this.showMessage(e,t.message,"error")},onFormError:function(t,e){console.error("FormManager: Form submission error",t),this.showToast("Ошибка отправки запроса","error")},showMessage:function(t,e,o){t&&(t.className="alert",t.classList.remove("d-none","alert-success","alert-danger"),"success"===o?t.classList.add("alert-success"):t.classList.add("alert-danger"),t.innerHTML=e)},destroy:function(){this.button&&this.button.removeEventListener("click",this.handleButtonClick);var t=document.getElementById(this.componentId+"_modal");t&&t.remove(),this.modalLoaded=!1}};