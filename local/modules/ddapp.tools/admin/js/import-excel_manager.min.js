BX.namespace("BX.DDAPP.Tools"),BX.DDAPP.Tools.ImportExcelManager=function(e){this.params=e||{},this.iblockId=e.iblockId||null,this.settings=e.settings||{},this.properties=e.properties||{},this.currentDialog=null,this.init()},BX.DDAPP.Tools.ImportExcelManager.prototype={init:function(){console.log("ImportExcelManager: Params",this.params);var e=this;window.openExcelModal=function(){e.openModal()}},openModal:function(){var e=this;this.currentDialog=new BX.CDialog({title:BX.message("DDAPP_EVENT_MODAL_TITLE"),content:BX("excel_import_div").innerHTML,width:500,height:250,resizable:!0,draggable:!0,buttons:[{title:BX.message("DDAPP_EVENT_MODAL_BTN_CLOSE"),id:"excel_import_close",name:"close",action:function(){this.parentWindow.Close()}}]}),this.currentDialog.Show(),setTimeout(function(){var t=document.querySelector(".bx-core-adm-dialog input[type=file]");t&&t.addEventListener("change",function(t){var r=t.target.files[0]?t.target.files[0].name:"",n=e.currentDialog.PARTS.CONTENT.querySelector("#file-name");n&&(n.textContent=r?BX.message("DDAPP_EVENT_MODAL_FILE")+r:""),e.handleExcelFile(t)})},100)},handleExcelFile:function(e){var t=this;BX.showWait();var r=e.target.files[0],n=new FileReader;n.onload=function(e){try{var r=new Uint8Array(e.target.result),n=XLSX.read(r,{type:"array"}),a=n.Sheets[n.SheetNames[0]];if(!t.settings||!t.settings.import_fields||!t.settings.import_cells)throw new Error("Import settings not found");var o=0,i=[];t.settings.import_fields.forEach(function(e){var r=t.settings.import_cells[e];if(r){var n=a[r]?a[r].v:"",s=t.getFieldSelector(e);if(s){var l=document.querySelector(s);l?(l.value=t.formatCellValue(n,e),o++):i.push(BX.message("DDAPP_EVENT_MESSAGE_FIELD_NOT_FOUND_ERROR")+e)}else i.push(BX.message("DDAPP_EVENT_MESSAGE_SELECTOR_NOT_TRUE_ERROR")+e)}else i.push(BX.message("DDAPP_EVENT_MESSAGE_CELL_IS_NULL_ERROR")+e)}),t.currentDialog&&t.currentDialog.Close();var s=BX.message("DDAPP_EVENT_MESSAGE_IMPORT_MESSAGE")+o;i.length>0&&(s+="<br>"+i.join("<br>")),t.showAlert(s)}catch(e){t.currentDialog&&t.currentDialog.Close(),t.showError(BX.message("DDAPP_EVENT_MESSAGE_FILE_IMPORT_ERROR")),console.error("ImportExcelManager: File Import Error",e.message)}finally{BX.closeWait()}},n.onerror=function(){BX.closeWait(),t.showError(BX.message("DDAPP_EVENT_MESSAGE_FILE_READ_ERROR")),console.error("ImportExcelManager: File Read Error")},n.readAsArrayBuffer(r)},getFieldSelector:function(e){switch(e){case"NAME":return'input[name="NAME"]';case"CODE":return'input[name="CODE"]';case"SORT":return'input[name="SORT"]';case"ACTIVE":return'input[name="ACTIVE"]';case"PREVIEW_TEXT":return'textarea[name="PREVIEW_TEXT"]';case"DETAIL_TEXT":return'textarea[name="DETAIL_TEXT"]';case"PREVIEW_PICTURE":return'input[name="PREVIEW_PICTURE"]';case"DETAIL_PICTURE":return'input[name="DETAIL_PICTURE"]';default:return this.getPropertySelector(e)}},getPropertySelector:function(e){if(this.properties&&this.properties[e])return'input[name="PROP['+(a=this.properties[e])+'][n0]"], textarea[name="PROP['+a+'][n0]"], select[name="PROP['+a+'][n0]"]';for(var t=document.querySelectorAll('input[name^="PROP["], textarea[name^="PROP["], select[name^="PROP["]'),r=0;r<t.length;r++){var n=(i=t[r]).name.match(/PROP\[(\d+)\]/);if(n){var a=n[1];for(var o in this.properties)if(this.properties[o]===a&&"PROPERTY_"+o===e)return'[name="'+i.name+'"]'}}var i,s=document.querySelector('[data-property-code="'+e+'"]');if(s&&((i=s.querySelector("input, textarea, select"))&&i.name))return'[name="'+i.name+'"]';return null},formatCellValue:function(e,t){if(null==e)return"";var r=String(e);return("number"==typeof e||/^\d+[,\.]\d+$/.test(r))&&(r=r.replace(",",".")),r},showAlert:function(e){BX.UI.Dialogs.MessageBox.alert(e,BX.message("DDAPP_EVENT_MESSAGE_TITLE"))},showError:function(e){BX.UI.Dialogs.MessageBox.alert(e,BX.message("DDAPP_EVENT_MESSAGE_ERROR"))}};